<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zehn AI - Personalized Learning</title>
    <link rel="icon" type="image/jpeg" href="assets/logo.jpg">
    <link rel="apple-touch-icon" href="assets/logo.jpg">
    <style>
        :root {
            /* Duolingo-inspired Purple Theme */
            --primary: #9333ea;
            --primary-hover: #7c3aed;
            --primary-light: #b855f7;
            --primary-dark: #6b21a8;

            --bg-main: #1f2937;
            --bg-header: #1a2332;
            --bg-card: #2d3748;
            --bg-card-hover: #374151;

            --text-primary: #ffffff;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --text-dark: #2C2C2C;

            --success: #58cc02;
            --success-hover: #4ab000;
            --error: #ff4b4b;
            --warning: #ffc800;

            --progress-bg: #374151;
            --progress-fill: #9333ea;

            --white: #FFFFFF;
            --border-color: #374151;
            --shadow-purple: rgba(147, 51, 234, 0.15);
            --shadow-purple-hover: rgba(147, 51, 234, 0.25);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', 'SF Pro Display', Roboto, sans-serif;
            background: #1f2937;
            min-height: 100vh;
            color: var(--text-primary);
            margin: 0;
            padding: 0;
        }

        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #1a2332;
            padding: 16px 24px;
            border-bottom: 2px solid #2d3748;
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: var(--text-primary);
            font-size: 1.5em;
            margin: 0;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .debug-toggle-btn {
            background: transparent;
            color: var(--text-secondary);
            border: 2px solid var(--card-bg);
            padding: 8px 16px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .debug-toggle-btn:hover {
            background: var(--card-hover);
            border-color: var(--primary);
            color: var(--primary);
        }

        .breadcrumb {
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
        }

        .breadcrumb a {
            color: var(--primary-light);
            text-decoration: none;
            transition: color 0.2s;
        }

        .breadcrumb a:hover {
            color: var(--primary);
            text-decoration: underline;
        }

        .content {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 40px 20px;
            width: 100%;
        }

        .page {
            display: none;
            width: 100%;
            max-width: 1200px;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-title {
            font-size: 1.8em;
            color: var(--text-primary);
            margin-bottom: 24px;
            font-weight: 700;
            letter-spacing: -0.3px;
        }

        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid var(--border-color);
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            border-color: var(--primary);
        }

        .card-clickable {
            cursor: pointer;
        }

        .card-title {
            font-size: 1.3em;
            color: var(--text-primary);
            font-weight: 700;
            margin-bottom: 12px;
            letter-spacing: -0.2px;
        }

        .card-subtitle {
            color: var(--text-secondary);
            margin-bottom: 16px;
            line-height: 1.6;
            opacity: 0.9;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        input[type="text"],
        input[type="email"],
        select,
        textarea {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
            background: var(--bg-card);
            color: var(--text-primary);
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--shadow-purple);
            background: var(--bg-card-hover);
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .radio-option {
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .radio-option:hover {
            border-color: var(--primary);
            background: var(--bg-card-hover);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .radio-option input[type="radio"] {
            margin-right: 10px;
        }

        .radio-option.selected {
            border-color: var(--primary);
            background: var(--bg-card-hover);
            box-shadow: 0 0 0 3px var(--shadow-purple);
        }

        button {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-hover));
            color: var(--white);
            border: 2px solid var(--primary);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-hover), var(--primary-dark));
            border-color: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--shadow-purple-hover);
        }

        .btn-secondary {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-secondary:hover {
            background: var(--card-hover);
            color: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--shadow-purple);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), var(--success-hover));
            color: var(--white);
            border: 2px solid var(--success);
        }

        .btn-success:hover {
            background: linear-gradient(135deg, var(--success-hover), #3d9600);
            border-color: var(--success-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(88, 204, 2, 0.35);
        }

        button:disabled {
            background: var(--progress-bg);
            color: var(--text-muted);
            cursor: not-allowed;
            transform: none;
            border: 2px solid var(--card-bg);
        }

        .badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
            margin-left: 10px;
        }

        .badge-success {
            background: var(--success);
            color: var(--white);
            font-weight: 700;
        }

        .badge-warning {
            background: var(--warning);
            color: var(--text-dark);
            font-weight: 600;
        }

        .badge-locked {
            background: var(--progress-bg);
            color: var(--text-muted);
        }

        .progress-bar {
            width: 100%;
            height: 24px;
            background: var(--progress-bg);
            border-radius: 12px;
            overflow: hidden;
            margin: 15px 0;
            border: 2px solid var(--card-bg);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-hover) 100%);
            transition: width 0.6s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: 600;
            font-size: 13px;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid var(--progress-bg);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-card);
            color: var(--text-primary);
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            animation: slideIn 0.3s;
            max-width: 400px;
            border: 2px solid var(--border-color);
        }

        @keyframes slideIn {
            from { transform: translateX(400px); }
            to { transform: translateX(0); }
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.error {
            border-left: 4px solid var(--error);
        }

        .flashcard {
            perspective: 1000px;
            height: 400px;
            margin: 40px 0;
        }

        /* ── Duolingo-exact flashcard ── */
        /* lesson page full-height layout — no scroll, everything fits viewport */
        .content:has(#page-lesson.active) {
            padding: 0;
            align-items: stretch;
        }
        body:has(#page-lesson.active) {
            overflow: hidden;
        }
        #page-lesson {
            display: none;
            flex-direction: column;
            height: calc(100vh - 58px);
            overflow: hidden;
        }
        #page-lesson.active {
            display: flex;
        }
        #page-lesson > .fc-back-btn {
            flex-shrink: 0;
            align-self: flex-start;
            margin: 12px 24px 0;
        }
        #page-lesson > .section-title {
            flex-shrink: 0;
            padding: 4px 24px 0;
        }
        #page-lesson > #lesson-content {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            padding: 0 24px 0;
            min-height: 0;
        }
        .fc-wrap {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
            padding-bottom: 70px;
        }
        .fc-body {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
            scrollbar-width: thin;
            scrollbar-color: #374151 transparent;
        }
        .fc-progress-bar { flex-shrink: 0; }
        .fc-bottom-bar   { flex-shrink: 0; }
        .fc-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 32px;
            gap: 0;
        }
        .fc-question {
            font-size: 1.35em;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 36px;
            text-align: center;
        }
        .fc-audio-btn {
            width: 130px; height: 130px;
            border-radius: 26px;
            background: linear-gradient(155deg, #b57bee, #7c3aed);
            border: none;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            color: white;
            box-shadow: 0 7px 0 #5b21b6;
            transition: transform 0.1s, box-shadow 0.1s;
            margin-bottom: 36px;
        }
        .fc-audio-btn:active { transform: translateY(5px); box-shadow: 0 2px 0 #5b21b6; }
        .fc-choices {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            width: 100%;
            max-width: 520px;
        }
        .fc-choice-flip { width: 100%; position: relative; perspective: 800px; }
        .fc-choice {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 14px;
            padding: 16px 18px;
            border-radius: 14px;
            border: 2px solid #374151;
            background: #1e2433;
            cursor: pointer;
            transition: border-color 0.15s, background 0.15s;
            text-align: center;
            width: 100%;
            box-sizing: border-box;
            min-height: 62px;
        }
        .fc-choice:hover { border-color: #9333ea; background: rgba(147,51,234,0.08); }
        .fc-choice.selected { border-color: #9333ea; background: rgba(147,51,234,0.15); }
        .fc-choice.correct  { border-color: #4ade80; background: rgba(74,222,128,0.12); }
        .fc-choice.wrong    { border-color: #f87171; background: rgba(248,113,113,0.12); }
        .fc-choice-num {
            width: 28px; height: 28px;
            border-radius: 7px;
            border: 2px solid #4b5563;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.78em;
            font-weight: 800;
            color: #9ca3af;
            flex-shrink: 0;
        }
        .fc-choice.selected .fc-choice-num { border-color: #9333ea; color: #9333ea; }
        .fc-choice.correct  .fc-choice-num { border-color: #4ade80; color: #4ade80; }
        .fc-choice.wrong    .fc-choice-num { border-color: #f87171; color: #f87171; }
        .fc-choice-text {
            font-size: 1em;
            font-weight: 600;
            color: var(--text-primary);
        }
        /* flashcard celebration screen */
        .fc-celebrate {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 40px 20px;
            gap: 16px;
            animation: celebrate-in 0.5s cubic-bezier(0.34,1.56,0.64,1) forwards;
        }
        @keyframes celebrate-in {
            from { opacity: 0; transform: scale(0.85) translateY(20px); }
            to   { opacity: 1; transform: scale(1) translateY(0); }
        }
        .fc-celebrate-emoji {
            font-size: 72px;
            animation: bounce-emoji 0.6s cubic-bezier(0.34,1.56,0.64,1) 0.2s both;
        }
        @keyframes bounce-emoji {
            from { transform: scale(0) rotate(-15deg); }
            to   { transform: scale(1) rotate(0deg); }
        }
        .fc-celebrate-title {
            font-size: 2em;
            font-weight: 900;
            color: #fff;
            letter-spacing: -0.01em;
        }
        .fc-celebrate-sub {
            font-size: 1em;
            color: #9ca3af;
            font-weight: 500;
        }
        .fc-confetti-wrap {
            position: relative;
            width: 100%;
        }
        @keyframes confetti-fall {
            0%   { transform: translateY(-20px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(80px) rotate(360deg); opacity: 0; }
        }
        .confetti-dot {
            position: absolute;
            width: 8px; height: 8px;
            border-radius: 2px;
            animation: confetti-fall 0.8s ease forwards;
        }
        /* story audio player bar */
        .story-player {
            position: relative;
            width: 100%;
            margin-bottom: 8px;
        }
        .story-play-btn {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 14px 20px;
            border-radius: 14px;
            border: none;
            background: linear-gradient(135deg, #b57bee, #7c3aed);
            color: #fff;
            font-size: 1em;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 0 #5b21b6;
            transition: transform 0.1s, box-shadow 0.1s;
            letter-spacing: 0.02em;
        }
        .story-play-btn:active {
            transform: translateY(3px);
            box-shadow: 0 1px 0 #5b21b6;
        }
        .story-pause-btn {
            background: linear-gradient(135deg, #6b7280, #374151);
            box-shadow: 0 4px 0 #1f2937;
        }
        /* back button */
        .fc-back-btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: rgba(147,51,234,0.08);
            border: 1.5px solid rgba(147,51,234,0.25);
            color: #9333ea;
            font-size: 0.82em;
            font-weight: 600;
            letter-spacing: 0.02em;
            padding: 5px 12px 5px 8px;
            border-radius: 20px;
            cursor: pointer;
            margin-bottom: 12px;
            transition: background 0.15s, border-color 0.15s, color 0.15s;
        }
        .fc-back-btn:hover {
            background: rgba(147,51,234,0.18);
            border-color: rgba(147,51,234,0.5);
            color: #d8b4fe;
        }
        .fc-back-btn svg {
            opacity: 0.8;
        }
        /* whole-button coin flip */
        @keyframes fc-flip-front {
            0%   { transform: rotateX(0deg); }
            50%  { transform: rotateX(90deg); }
            100% { transform: rotateX(0deg); }
        }
        @keyframes fc-flip-inner {
            0%   { transform: rotateX(0deg); opacity: 1; }
            49%  { transform: rotateX(90deg); opacity: 0; }
            50%  { transform: rotateX(-90deg); opacity: 0; }
            100% { transform: rotateX(0deg); opacity: 1; }
        }
        .fc-choice.flipped {
            transform: rotateX(0deg);
        }
        .fc-choice.flipping {
            animation: fc-flip-front 0.45s ease forwards;
        }
        .fc-choice.flipping .fc-choice-num,
        .fc-choice.flipping .fc-choice-text {
            animation: fc-flip-inner 0.45s ease forwards;
        }
        /* hover re-flip on already-flipped buttons */
        @keyframes fc-text-out {
            0%   { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }
        @keyframes fc-text-in {
            0%   { opacity: 0; transform: translateY(10px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        .fc-choice-text.text-out {
            animation: fc-text-out 0.15s ease forwards;
        }
        .fc-choice-text.text-in {
            animation: fc-text-in 0.15s ease forwards;
        }
        /* fixed bottom bar (skip / next) */
        .fc-bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            border-top: 2px solid #2d3748;
            background: var(--bg-primary, #111827);
            padding: 14px 24px calc(14px + env(safe-area-inset-bottom));
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }
        /* inline check button below options */
        .fc-btn-check-inline {
            display: block;
            width: 100%;
            margin-top: 20px;
        }
        .fc-btn-skip {
            padding: 11px 24px;
            border-radius: 12px;
            border: 2px solid #374151;
            background: transparent;
            color: #6b7280;
            font-weight: 700;
            font-size: 0.82em;
            cursor: pointer;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            transition: background 0.15s;
        }
        .fc-btn-skip:hover { background: #2d3748; color: var(--text-primary); }
        .fc-btn-check {
            padding: 11px 32px;
            border-radius: 12px;
            border: none;
            background: #374151;
            color: #6b7280;
            font-weight: 800;
            font-size: 0.82em;
            cursor: default;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            box-shadow: 0 4px 0 #1f2937;
            transition: background 0.15s, color 0.15s, box-shadow 0.15s, transform 0.1s;
        }
        .fc-btn-check.active {
            background: linear-gradient(135deg, #9333ea, #7c3aed);
            color: white;
            box-shadow: 0 4px 0 #5b21b6;
            cursor: pointer;
        }
        .fc-btn-check.active:active { transform: translateY(3px); box-shadow: 0 1px 0 #5b21b6; }
        .fc-btn-next {
            padding: 11px 32px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, #9333ea, #7c3aed);
            color: white;
            font-weight: 800;
            font-size: 0.82em;
            cursor: pointer;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            box-shadow: 0 4px 0 #5b21b6;
            transition: transform 0.1s;
        }
        .fc-btn-next:active { transform: translateY(3px); box-shadow: 0 1px 0 #5b21b6; }
        /* progress bar */
        .fc-progress-bar {
            height: 8px;
            background: #2d3748;
            border-radius: 4px;
            margin-bottom: 6px;
            overflow: hidden;
        }
        .fc-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #9333ea, #9333ea);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        .fc-counter {
            text-align: center;
            font-size: 0.78em;
            color: var(--text-secondary);
            margin-bottom: 0;
            font-weight: 600;
        }

        .flashcard-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }

        .flashcard.flipped .flashcard-inner {
            transform: rotateY(180deg);
        }

        .flashcard-front,
        .flashcard-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
            color: var(--white);
            border-radius: 16px;
            padding: 40px;
            font-size: 2em;
            text-align: center;
            box-shadow: 0 8px 24px var(--shadow-purple-hover);
            border: 2px solid var(--primary-light);
        }

        .flashcard-back {
            transform: rotateY(180deg);
            background: linear-gradient(135deg, var(--primary-hover) 0%, var(--primary-dark) 100%);
        }

        .lesson-nav {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .question-card {
            background: var(--bg-card);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid var(--border-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .question-title {
            font-size: 1.2em;
            color: var(--text-primary);
            margin-bottom: 15px;
            font-weight: 600;
        }

        .answer-option {
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .answer-option:hover {
            border-color: var(--primary);
            background: var(--bg-card-hover);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .answer-option.selected {
            border-color: var(--primary);
            background: var(--bg-card-hover);
            box-shadow: 0 0 0 3px var(--shadow-purple);
        }

        .answer-option.correct {
            border-color: var(--success);
            background: rgba(88, 204, 2, 0.15);
        }

        .answer-option.incorrect {
            border-color: var(--error);
            background: rgba(255, 75, 75, 0.15);
        }

        /* One-at-a-time test question styles */
        .tq-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            background: var(--bg-card);
            color: var(--text-primary);
            transition: border-color 0.15s, background 0.15s;
            user-select: none;
        }
        .tq-option:hover { border-color: #9333ea; background: rgba(147,51,234,0.08); }
        .tq-option.selected { border-color: #9333ea; background: rgba(147,51,234,0.15); }
        .tq-option.correct  { border-color: var(--success); background: rgba(88,204,2,0.12); cursor: default; }
        .tq-option.incorrect{ border-color: var(--error);   background: rgba(255,75,75,0.12);  cursor: default; }
        .tq-num {
            width: 30px; height: 30px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            display: flex; align-items: center; justify-content: center;
            font-size: 0.85em; font-weight: 700;
            flex-shrink: 0;
            transition: border-color 0.15s, color 0.15s;
        }
        .tq-option.selected  .tq-num { border-color: #9333ea; color: #9333ea; }
        .tq-option.correct   .tq-num { border-color: var(--success); color: var(--success); }
        .tq-option.incorrect .tq-num { border-color: var(--error);   color: var(--error); }
        .tq-explanation {
            margin-top: 14px;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 0.9em;
            line-height: 1.5;
        }
        .tq-exp-correct { background: rgba(88,204,2,0.12); border: 1.5px solid var(--success); color: #a3e635; }
        .tq-exp-wrong   { background: rgba(255,75,75,0.10); border: 1.5px solid var(--error);   color: #fca5a5; }
        .tq-review-item {
            display: flex;
            gap: 12px;
            align-items: flex-start;
            padding: 12px 14px;
            border-radius: 10px;
            margin-bottom: 10px;
            border: 1.5px solid var(--border-color);
            background: var(--bg-card);
        }
        .tq-review-ok   { border-color: var(--success); }
        .tq-review-wrong{ border-color: var(--error); }
        .tq-review-num {
            font-size: 1.1em;
            font-weight: 800;
            width: 24px;
            flex-shrink: 0;
            margin-top: 2px;
        }
        .tq-review-ok   .tq-review-num { color: var(--success); }
        .tq-review-wrong .tq-review-num { color: var(--error); }

        /* Correct answer fullscreen flash */
        #tq-correct-overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 8000;
            pointer-events: none;
            align-items: center;
            justify-content: center;
        }
        #tq-correct-overlay.visible {
            display: flex;
        }
        #tq-correct-overlay dotlottie-player {
            width: 100vw;
            height: 100vh;
        }

        /* Fill-in-blank drag-drop */
        .tq-fill-sentence { display: block; }
        .tq-drop-zone {
            display: inline-flex;
            align-items: center;
            min-width: 90px;
            padding: 2px 12px;
            border-radius: 8px;
            border: 2px dashed var(--primary);
            background: rgba(206,130,255,0.07);
            color: var(--primary);
            font-weight: 600;
            cursor: pointer;
            vertical-align: middle;
            transition: border-color 0.15s, background 0.15s;
        }
        .tq-drop-zone.filled {
            border-style: solid;
            border-color: #9333ea;
            background: rgba(147,51,234,0.15);
            color: var(--text-primary);
            cursor: pointer;
        }
        .tq-drop-zone.filled:hover {
            background: rgba(147,51,234,0.25);
        }
        .tq-drop-zone.correct  { border-color: var(--success); background: rgba(88,204,2,0.12); color: #4ade80; }
        .tq-drop-zone.incorrect{ border-color: var(--error);   background: rgba(255,75,75,0.12);  color: #f87171; }
        .tq-drop-zone:not(.filled):not(.correct):not(.incorrect):hover {
            border-color: #9333ea; background: rgba(147,51,234,0.12);
        }
        .tq-drop-placeholder { opacity: 0.5; font-style: italic; }
        .tq-drop-word { font-weight: 700; }
        .tq-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 28px;
            justify-content: center;
        }
        .tq-chip {
            padding: 10px 20px;
            border-radius: 24px;
            border: 2px solid #9333ea;
            background: rgba(147,51,234,0.12);
            color: var(--text-primary);
            font-size: 1em;
            font-weight: 600;
            cursor: grab;
            transition: background 0.15s, border-color 0.15s;
            user-select: none;
            touch-action: none;
        }
        .tq-chip:hover { background: rgba(147,51,234,0.25); }
        .tq-chip.tq-chip-hidden {
            visibility: hidden;
            pointer-events: none;
        }

        .story-content {
            font-size: 1.1em;
            line-height: 1.8;
            color: var(--text-primary);
            padding: 20px;
        }

        .story-content p {
            margin-bottom: 15px;
        }

        .story-word {
            transition: all 0.2s ease;
            padding: 2px 4px;
            border-radius: 4px;
        }

        .story-word.highlighted {
            background-color: var(--primary);
            color: var(--white);
            font-weight: 600;
            transform: scale(1.1);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
            color: var(--white);
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid var(--primary-light);
            box-shadow: 0 4px 12px var(--shadow-purple);
        }

        .stat-value {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1em;
            opacity: 0.9;
        }

        .unit-card {
            position: relative;
        }

        .unit-card.locked {
            opacity: 0.6;
            pointer-events: none;
        }

        .lock-icon {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 1.5em;
        }

        .debug-console {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #1a2332;
            color: var(--text-secondary);
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            border-top: 2px solid var(--primary);
            z-index: 9999;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .debug-console.hidden {
            transform: translateY(100%);
            opacity: 0;
        }

        .debug-console .log {
            margin-bottom: 8px;
            padding: 5px;
            border-left: 3px solid var(--success);
            padding-left: 10px;
        }

        .debug-console .log.error {
            border-left-color: var(--error);
            color: #ff6b6b;
        }

        .debug-console .log.info {
            border-left-color: var(--primary);
            color: var(--primary-light);
        }

        .debug-console .log.warn {
            border-left-color: var(--warning);
            color: #ffb74d;
        }

        .debug-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #444;
        }

        .debug-header button {
            padding: 5px 15px;
            font-size: 12px;
        }

        /* Duolingo-style Onboarding */
        .onboarding-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .onboarding-progress {
            width: 100%;
            height: 16px;
            background: var(--progress-bg);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 60px;
        }

        .onboarding-progress-fill {
            height: 100%;
            background: var(--success);
            transition: width 0.4s ease;
        }

        .onboarding-question {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .onboarding-question.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .mascot-section {
            display: flex;
            align-items: flex-start;
            gap: 30px;
            margin-bottom: 40px;
        }

        .mascot {
            font-size: 120px;
            flex-shrink: 0;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .speech-bubble {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 20px 30px;
            position: relative;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            max-width: 600px;
        }

        .speech-bubble::before {
            content: '';
            position: absolute;
            left: -20px;
            top: 30px;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 10px 20px 10px 0;
            border-color: transparent var(--border-color) transparent transparent;
        }

        .speech-bubble::after {
            content: '';
            position: absolute;
            left: -14px;
            top: 33px;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 7px 14px 7px 0;
            border-color: transparent var(--bg-card) transparent transparent;
        }

        .speech-bubble h2 {
            margin: 0;
            font-size: 1.5em;
            color: var(--text-primary);
            font-weight: 600;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 40px;
        }

        .option-card {
            background: var(--bg-card);
            border: 3px solid var(--border-color);
            border-radius: 16px;
            padding: 18px 12px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-height: 110px;
            text-align: center;
        }

        .option-card:hover {
            background: var(--bg-card-hover);
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .option-card.selected {
            background: var(--bg-card-hover);
            border-color: var(--primary);
            box-shadow: 0 0 0 4px var(--shadow-purple);
        }

        .option-icon {
            font-size: 1.6em;
            flex-shrink: 0;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .option-text {
            flex: none;
            width: 100%;
        }

        .option-title {
            font-size: 0.95em;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
            line-height: 1.2;
        }

        .option-subtitle {
            font-size: 0.8em;
            color: var(--text-secondary);
            margin: 3px 0 0 0;
        }

        .onboarding-actions {
            display: flex;
            justify-content: flex-end;
            gap: 16px;
            padding-top: 20px;
        }

        .btn-continue {
            background: var(--success);
            color: var(--white);
            border: none;
            padding: 16px 48px;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-continue:hover:not(:disabled) {
            background: var(--success-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(88, 204, 2, 0.4);
        }

        .btn-continue:disabled {
            background: var(--progress-bg);
            color: var(--text-muted);
            cursor: not-allowed;
            opacity: 0.5;
        }

        .btn-back {
            background: transparent;
            color: var(--text-secondary);
            border: 2px solid var(--card-bg);
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-back:hover {
            background: var(--card-hover);
            border-color: var(--primary);
            color: var(--text-primary);
        }

        /* Single column for proficiency level options */
        .options-grid.single-column {
            grid-template-columns: 1fr;
            max-width: 800px;
        }

        /* Single-column cards go back to horizontal (icon left, text right) */
        .options-grid.single-column .option-card {
            flex-direction: row;
            text-align: left;
            padding: 18px 24px;
            gap: 16px;
            min-height: 72px;
        }

        .options-grid.single-column .option-text {
            width: auto;
            flex: 1;
        }

        .options-grid.single-column .option-title {
            font-size: 1.05em;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .options-grid {
                grid-template-columns: 1fr;
            }

            .mascot-section {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }

            .speech-bubble::before,
            .speech-bubble::after {
                display: none;
            }

            .mascot {
                font-size: 80px;
            }
        }

        /* Login/Auth Modal Overlay */
        /* ── Guidebook Modal ── */
        .guidebook-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(6px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1100;
        }
        .guidebook-overlay.active {
            display: flex;
        }
        .guidebook-modal {
            background: #1a1f2e;
            border-radius: 24px;
            width: calc(100% - 40px);
            max-width: 680px;
            max-height: 88vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 24px 64px rgba(0,0,0,0.6);
            animation: gbScaleIn 0.28s cubic-bezier(0.34,1.3,0.64,1);
        }
        @keyframes gbScaleIn {
            from { transform: scale(0.82); opacity: 0; }
            to   { transform: scale(1);    opacity: 1; }
        }
        .guidebook-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 28px 28px 20px;
            border-bottom: 1px solid #2d3748;
            flex-shrink: 0;
        }
        .guidebook-header-left {
            display: flex;
            align-items: center;
            gap: 18px;
        }
        .guidebook-mascot {
            font-size: 56px;
            animation: float 3s ease-in-out infinite;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.4));
            flex-shrink: 0;
        }
        .guidebook-unit-label {
            font-size: 0.75em;
            font-weight: 800;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 4px;
        }
        .guidebook-title {
            font-size: 1.5em;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        .guidebook-subtitle {
            font-size: 0.88em;
            color: var(--text-secondary);
        }
        .guidebook-close {
            width: 40px; height: 40px;
            min-width: 40px; min-height: 40px;
            border-radius: 50%;
            background: #2d3748;
            border: none;
            color: var(--text-secondary);
            font-size: 1em;
            line-height: 1;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: background 0.2s, color 0.2s;
            flex-shrink: 0;
            padding: 0;
        }
        .guidebook-close:hover { background: #4b5563; color: var(--text-primary); }

        .guidebook-body {
            overflow-y: auto;
            padding: 24px 28px 40px;
            flex: 1;
        }
        .guidebook-body::-webkit-scrollbar { width: 4px; }
        .guidebook-body::-webkit-scrollbar-track { background: transparent; }
        .guidebook-body::-webkit-scrollbar-thumb { background: #374151; border-radius: 2px; }

        .guidebook-loading {
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            padding: 60px 0;
            gap: 16px;
            color: var(--text-secondary);
        }

        /* Section label like "KEY PHRASES" */
        .guidebook-section-label {
            font-size: 0.72em;
            font-weight: 800;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin: 28px 0 8px;
        }
        .guidebook-section-label:first-child { margin-top: 0; }

        /* Lesson heading inside guidebook */
        .guidebook-lesson-title {
            font-size: 1.25em;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        /* Vocabulary word cards */
        .guidebook-words {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 8px;
        }
        .guidebook-word-card {
            display: flex;
            align-items: center;
            gap: 14px;
            background: #2d3748;
            border-radius: 14px;
            padding: 14px 18px;
            cursor: pointer;
            transition: background 0.2s, transform 0.15s;
            border: 1px solid transparent;
        }
        .guidebook-word-card:hover {
            background: #374151;
            border-color: var(--primary);
            transform: translateX(4px);
        }
        .guidebook-word-icon {
            width: 42px; height: 42px;
            border-radius: 10px;
            background: linear-gradient(135deg, #9333ea, #9333ea);
            display: flex; align-items: center; justify-content: center;
            font-size: 1.3em;
            flex-shrink: 0;
            box-shadow: 0 3px 0 #6b21a8;
        }
        .guidebook-word-img {
            width: 42px; height: 42px;
            border-radius: 10px;
            object-fit: cover;
            flex-shrink: 0;
        }
        .guidebook-word-text {
            flex: 1;
        }
        .guidebook-word-target {
            font-size: 1em;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 3px;
        }
        .guidebook-word-dotted {
            border-bottom: 2px dashed #4b5563;
            margin-bottom: 3px;
        }
        .guidebook-word-native {
            font-size: 0.85em;
            color: var(--text-secondary);
        }
        .guidebook-word-audio {
            width: 34px; height: 34px;
            border-radius: 50%;
            background: #374151;
            border: none;
            color: var(--primary);
            font-size: 1em;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: background 0.2s, transform 0.15s;
            flex-shrink: 0;
        }
        .guidebook-word-audio:hover { background: var(--primary); color: #fff; transform: scale(1.1); }

        /* Divider between lessons */
        .guidebook-divider {
            height: 1px;
            background: #2d3748;
            margin: 28px 0;
        }

        /* Section overview cards (Flashcard / Story / Test) */
        .guidebook-section-cards {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 4px;
        }
        .guidebook-sec-card {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 18px;
            border-radius: 16px;
            border-left: 4px solid transparent;
        }
        .guidebook-sec-card.flashcard-card {
            background: rgba(168, 85, 216, 0.12);
            border-left-color: #9333ea;
        }
        .guidebook-sec-card.story-card {
            background: rgba(59, 130, 246, 0.12);
            border-left-color: #3b82f6;
        }
        .guidebook-sec-card.test-card {
            background: rgba(16, 185, 129, 0.12);
            border-left-color: #10b981;
        }
        .guidebook-sec-icon {
            width: 44px; height: 44px;
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .flashcard-card .guidebook-sec-icon { background: #9333ea; }
        .story-card     .guidebook-sec-icon { background: #3b82f6; }
        .test-card      .guidebook-sec-icon { background: #10b981; }
        .guidebook-sec-text { flex: 1; }
        .guidebook-sec-title {
            font-size: 0.95em;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        .guidebook-sec-desc {
            font-size: 0.82em;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* KEY PHRASES section */
        .guidebook-key-phrases {
            margin-bottom: 20px;
        }
        .guidebook-key-phrases-label {
            font-size: 0.72em;
            font-weight: 900;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }
        .guidebook-phrase-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .guidebook-phrase-chip {
            background: rgba(147, 51, 234, 0.15);
            border: 1px solid rgba(147, 51, 234, 0.35);
            color: #9333ea;
            border-radius: 20px;
            padding: 5px 14px;
            font-size: 0.83em;
            font-weight: 600;
        }
        .guidebook-divider {
            height: 1px;
            background: rgba(255,255,255,0.07);
            margin: 16px 0;
        }
        .guidebook-sections-label {
            font-size: 0.72em;
            font-weight: 900;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .auth-overlay.active {
            display: flex;
        }

        .auth-modal {
            background: #1a2332;
            border-radius: 20px;
            padding: 60px;
            max-width: 450px;
            width: 90%;
            position: relative;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .auth-close {
            position: absolute;
            top: 20px;
            left: 20px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            transition: color 0.2s;
        }

        .auth-close:hover {
            color: var(--text-primary);
        }

        .auth-signup-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
            padding: 10px 24px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 0.5px;
        }

        .auth-signup-btn:hover {
            background: var(--primary);
            color: var(--white);
        }
        .auth-signup-btn.is-login-mode {
            border-color: var(--primary);
            color: var(--primary);
        }

        .auth-otp-hint {
            font-size: 0.85em;
            color: var(--text-secondary);
            text-align: center;
            margin: 0 0 14px;
            line-height: 1.5;
        }
        .auth-otp-hint strong { color: var(--text-primary); }

        .auth-modal h2 {
            text-align: center;
            font-size: 2em;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 40px 0;
        }

        .auth-input {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #374151;
            border-radius: 12px;
            font-size: 16px;
            background: #2d3748;
            color: var(--text-primary);
            margin-bottom: 16px;
            transition: all 0.3s;
        }

        .auth-input:focus {
            outline: none;
            border-color: var(--primary);
            background: #374151;
        }

        .auth-input::placeholder {
            color: var(--text-muted);
        }

        .auth-submit-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #9333ea, #7c3aed);
            border: none;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 700;
            color: var(--white);
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 20px;
            box-shadow: 0 4px 0 #6b21a8;
        }

        .auth-submit-btn:hover {
            background: linear-gradient(135deg, #a855f7, #9333ea);
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #6b21a8, 0 8px 20px rgba(147,51,234,0.4);
        }

        .auth-submit-btn:active:not(:disabled) {
            transform: translateY(2px);
            box-shadow: 0 1px 0 #6b21a8;
            background: linear-gradient(135deg, #7c3aed, #6b21a8);
        }

        @keyframes btn-press {
            0%   { transform: scale(1); }
            40%  { transform: scale(0.93); }
            100% { transform: scale(1); }
        }
        .auth-submit-btn.pressed {
            animation: btn-press 0.3s ease;
        }

        .auth-submit-btn:disabled {
            background: #4b5563;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .auth-divider {
            display: flex;
            align-items: center;
            margin: 24px 0;
            color: var(--text-muted);
            font-size: 0.9em;
        }

        .auth-divider::before,
        .auth-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #374151;
        }

        .auth-divider span {
            padding: 0 16px;
        }

        .auth-social-btns {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .auth-social-btn {
            flex: 1;
            padding: 14px;
            background: transparent;
            border: 2px solid #374151;
            border-radius: 12px;
            color: var(--text-secondary);
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 0.85em;
            letter-spacing: 0.5px;
        }

        .auth-social-btn:hover {
            border-color: #6b7280;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }

        .auth-social-btn svg {
            flex-shrink: 0;
        }

        .auth-footer {
            text-align: center;
            font-size: 0.85em;
            color: var(--text-muted);
            line-height: 1.6;
        }

        .auth-footer a {
            color: var(--primary);
            text-decoration: none;
        }

        .auth-footer a:hover {
            text-decoration: underline;
        }

        .forgot-link {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 0.85em;
            text-decoration: none;
            transition: color 0.2s;
        }

        .forgot-link:hover {
            color: var(--primary);
        }

        .input-wrapper {
            position: relative;
            margin-bottom: 16px;
        }

        /* Professional Landing Page */
        .landing-hero {
            text-align: center;
            padding: 80px 20px 60px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .hero-mascot {
            font-size: 150px;
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
            display: inline-block;
        }

        .hero-title {
            font-size: 3.5em;
            font-weight: 800;
            margin: 0 0 20px 0;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hero-subtitle {
            font-size: 1.5em;
            color: var(--text-secondary);
            margin: 0 0 50px 0;
            font-weight: 400;
        }

        .hero-cta {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 80px;
        }

        .btn-large {
            padding: 20px 40px;
            font-size: 1.2em;
            font-weight: 700;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            min-width: 200px;
        }

        .btn-primary-large {
            background: linear-gradient(135deg, var(--primary), var(--primary-hover));
            color: var(--white);
            border: 2px solid var(--primary);
        }

        .btn-primary-large:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px var(--shadow-purple-hover);
        }

        .btn-secondary-large {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-secondary-large:hover {
            background: var(--card-hover);
            transform: translateY(-3px);
            box-shadow: 0 10px 30px var(--shadow-purple);
        }

        .features-section {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .features-title {
            text-align: center;
            font-size: 2.5em;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 50px;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 30px;
            margin-bottom: 60px;
        }

        .feature-card {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 20px;
            padding: 40px 30px;
            text-align: center;
            transition: all 0.3s;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        .feature-icon {
            font-size: 4em;
            margin-bottom: 20px;
            display: block;
        }

        .feature-title {
            font-size: 1.3em;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 15px 0;
        }

        .feature-description {
            font-size: 1em;
            color: var(--text-secondary);
            line-height: 1.6;
            margin: 0;
        }

        .auth-card {
            max-width: 500px;
            margin: 40px auto;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        .auth-card-title {
            font-size: 1.8em;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 10px 0;
            text-align: center;
        }

        .auth-card-subtitle {
            font-size: 1em;
            color: var(--text-secondary);
            margin: 0 0 30px 0;
            text-align: center;
        }

        .divider {
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
            margin: 60px 0;
        }

        @media (max-width: 768px) {
            .hero-title {
                font-size: 2.5em;
            }

            .hero-subtitle {
                font-size: 1.2em;
            }

            .hero-mascot {
                font-size: 100px;
            }

            .features-title {
                font-size: 2em;
            }
        }

        /* Full Continuous Path */
        .full-path {
            max-width: 700px;
            margin: 0 auto;
            padding: 20px 20px 80px;
        }

        .unit-section {
            margin-bottom: 10px;
        }

        /* Sticky unit headers — each one stacks on the previous as you scroll */
        #page-curriculum .unit-section .unit-header,
        #units-grid .unit-section .unit-header {
            position: sticky;
            z-index: 10;
            margin-bottom: 0;
        }
        /* 12px gap below navbar so the card looks floating, not glued */
        #units-grid .unit-section:nth-child(1) .unit-header { top: 70px; z-index: 19; }
        #units-grid .unit-section:nth-child(2) .unit-header { top: 70px; z-index: 18; }
        #units-grid .unit-section:nth-child(3) .unit-header { top: 70px; z-index: 17; }
        #units-grid .unit-section:nth-child(4) .unit-header { top: 70px; z-index: 16; }
        #units-grid .unit-section:nth-child(5) .unit-header { top: 70px; z-index: 15; }
        #units-grid .unit-section:nth-child(6) .unit-header { top: 70px; z-index: 14; }
        #units-grid .unit-section:nth-child(7) .unit-header { top: 70px; z-index: 13; }
        #units-grid .unit-section:nth-child(8) .unit-header { top: 70px; z-index: 12; }
        /* Keep original look when stuck — no shape/size changes */
        #units-grid .unit-section .unit-header.is-stuck {
            border-radius: 18px;
            padding: 20px 24px;
            box-shadow: 0 6px 0 var(--uh-shadow), 0 10px 24px rgba(0,0,0,0.3);
        }

        /* Topic-based unit header colors */
        .unit-header { --uh-a: #58a4f7; --uh-b: #2563eb; --uh-shadow: #1d4ed8; }
        .unit-header.topic-travel    { --uh-a: #58CC03; --uh-b: #45a302; --uh-shadow: #2d6b01; }
        .unit-header.topic-food      { --uh-a: #FF9601; --uh-b: #cc7800; --uh-shadow: #8f5400; }
        .unit-header.topic-sports    { --uh-a: #f472b6; --uh-b: #db2777; --uh-shadow: #be185d; }
        .unit-header.topic-technology{ --uh-a: #60a5fa; --uh-b: #2563eb; --uh-shadow: #1d4ed8; }
        .unit-header.topic-health    { --uh-a: #58CC03; --uh-b: #45a302; --uh-shadow: #2d6b01; }
        .unit-header.topic-education { --uh-a: #9333ea; --uh-b: #6b21a8; --uh-shadow: #4c1476; }
        .unit-header.topic-culture   { --uh-a: #FF9601; --uh-b: #cc7800; --uh-shadow: #8f5400; }
        .unit-header.topic-daily     { --uh-a: #9333ea; --uh-b: #6b21a8; --uh-shadow: #4c1476; }
        .unit-header.topic-entertainment{ --uh-a: #FF4B4B; --uh-b: #cc3333; --uh-shadow: #8f1f1f; }
        .unit-header.topic-shopping  { --uh-a: #38bdf8; --uh-b: #0284c7; --uh-shadow: #0369a1; }
        .unit-header.topic-business  { --uh-a: #2dd4bf; --uh-b: #0d9488; --uh-shadow: #0f766e; }

        .unit-header-locked {
            filter: saturate(0.25) brightness(0.7);
        }

        /* Snake zig-zag offsets */
        .path-offset-center { margin-left: 0; }
        .path-offset-right  { margin-left: 140px; }
        .path-offset-left   { margin-left: -140px; }

        /* Unit header banner */
        /* Sticky wrapper for unit header */
        #unit-description-sticky {
            position: sticky;
            top: 58px;
            z-index: 90;
            max-width: 700px;
            margin: 0 auto;
            /* Solid background — nothing bleeds through */
            background: #1f2937;
            padding: 12px 20px 12px;
        }

        .unit-header {
            background: linear-gradient(135deg, var(--uh-a), var(--uh-b));
            border-radius: 18px;
            padding: 20px 24px;
            margin-bottom: 0;
            color: var(--white);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 6px 0 var(--uh-shadow), 0 10px 24px rgba(0,0,0,0.3);
            position: relative;
        }

        /* Keep original look when stuck — no shape changes */
        #unit-description-sticky.is-stuck .unit-header {
            border-radius: 18px;
            padding: 20px 24px;
            box-shadow: 0 6px 0 var(--uh-shadow), 0 10px 24px rgba(0,0,0,0.3);
        }
        /* Spacer so content below doesn't jump when header sticks */
        #unit-header-spacer {
            height: 0;
            transition: height 0.25s ease;
        }
        #unit-description-sticky.is-stuck ~ #unit-header-spacer,
        #unit-header-spacer.active {
            height: 100px;
        }

        .unit-header-left {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .unit-header-back {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.72em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.85;
            margin-bottom: 6px;
        }

        .unit-header-left h2 {
            font-size: 0.75em;
            font-weight: 700;
            margin: 0 0 5px 0;
            opacity: 0.85;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .unit-header-left h1 {
            font-size: 1.6em;
            font-weight: 800;
            margin: 0;
            line-height: 1.2;
        }

        /* Guidebook button — outline pill with icon */
        .btn-guidebook {
            background: rgba(255,255,255,0.15);
            border: 2.5px solid rgba(255,255,255,0.9);
            color: var(--white);
            padding: 11px 20px 11px 14px;
            border-radius: 14px;
            font-weight: 800;
            font-size: 0.82em;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            cursor: pointer;
            transition: background 0.2s, transform 0.15s;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
            white-space: nowrap;
        }
        .btn-guidebook:hover {
            background: rgba(255,255,255,0.28);
            transform: scale(1.04);
        }
        /* Notebook/list SVG icon inside guidebook button */
        .guidebook-icon {
            width: 28px; height: 28px;
            background: rgba(255,255,255,0.25);
            border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }

        .lesson-path {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px 30px;
            gap: 0;
            position: relative;
        }

        /* Each node row: holds the circle + optional side mascot */
        .lesson-node {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 1;
            transition: margin-left 0.3s ease;
        }

        /* Outer dark ring wrapper — the Duolingo arc ring */
        .lesson-ring {
            width: 104px; height: 104px;
            border-radius: 50%;
            background: #1a2030;
            display: flex; align-items: center; justify-content: center;
            position: relative;
            box-shadow: 0 8px 0 #0d1117, 0 12px 28px rgba(0,0,0,0.5);
            cursor: pointer;
            transition: transform 0.15s;
        }
        .lesson-ring:hover:not(.locked) { transform: translateY(-4px); }
        .lesson-ring:active:not(.locked) {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #0d1117, 0 4px 10px rgba(0,0,0,0.3);
        }
        .lesson-ring.locked { cursor: not-allowed; opacity: 0.55; }

        /* Partial SVG arc on the ring */
        .lesson-ring-svg {
            position: absolute;
            top: 0; left: 0;
            width: 104px; height: 104px;
            transform: rotate(-90deg);
            pointer-events: none;
        }
        .lesson-ring-svg circle {
            fill: none;
            stroke-width: 7;
            stroke-linecap: round;
        }
        .lesson-ring-svg .ring-bg   { stroke: #2d3748; }
        /* Segment arcs — filled dynamically via inline stroke/dasharray attrs */
        .lesson-ring-svg .ring-seg  { stroke-linecap: round; }
        .lesson-ring-svg .ring-seg-inactive { stroke: transparent; }
        .lesson-ring-svg .ring-seg-active   { stroke: var(--lc-a, #9333ea); }
        .lesson-ring-svg .ring-seg-done     { stroke: #4ade80; }

        /* 3D inner circle */
        .lesson-circle {
            width: 80px; height: 80px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            transition: none;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        /* Shine overlay */
        .lesson-circle::before {
            content: '';
            position: absolute;
            top: 7px; left: 13px;
            width: 50%; height: 35%;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            filter: blur(4px);
            pointer-events: none;
        }

        /* Topic-based active circle color via CSS vars */
        .lesson-circle { --lc-a: #b855f7; --lc-b: #7c3aed; --lc-s: #6b21a8; }

        .lesson-ring.active   .lesson-circle {
            background: linear-gradient(155deg, var(--lc-a), var(--lc-b));
            box-shadow: 0 6px 0 var(--lc-s);
        }
        .lesson-ring.completed .lesson-circle {
            background: linear-gradient(155deg, #4ade80, #16a34a);
            box-shadow: 0 6px 0 #14532d;
        }
        /* Golden ring when entire unit is completed */
        .lesson-ring.unit-done {
            overflow: visible;
        }
        .lesson-ring.unit-done .lesson-circle {
            background: linear-gradient(155deg, #fbbf24, #f59e0b);
            box-shadow: 0 6px 0 #92400e, 0 0 20px rgba(251,191,36,0.4);
        }
        .lesson-ring.unit-done .ring-bg {
            stroke: rgba(251,191,36,0.15);
        }
        .lesson-ring.locked .lesson-circle {
            background: linear-gradient(155deg, #374151, #1f2937);
            box-shadow: 0 6px 0 #0d1117;
        }
        .lesson-ring.locked .lesson-circle::before { display: none; }

        /* White star SVG icon */
        .star-icon {
            width: 38px; height: 38px;
            fill: white;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
            position: relative; z-index: 1;
        }
        .lesson-ring.locked .star-icon { fill: #6b7280; }

        /* Jump-here flat colored disc (no dark ring, no arc) */
        .lesson-jump-circle {
            width: 104px; height: 104px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            transition: transform 0.15s;
            position: relative;
        }
        .lesson-jump-circle:hover { transform: translateY(-4px); }
        .lesson-jump-circle:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 rgba(0,0,0,0.4) !important;
        }
        .lesson-jump-circle .star-icon {
            width: 44px; height: 44px;
            fill: white;
            filter: drop-shadow(0 2px 6px rgba(0,0,0,0.4));
        }

        /* Remove old circle (keep hidden for compat) */
        .lesson-progress-ring { display: none; }

        /* START — speech bubble pointing DOWN to circle */
        /* START label slow float — ring and island stay completely still */
        @keyframes startLabelFloat {
            0%   { transform: translateY(0px); }
            50%  { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        /* Only the START bubble floats gently up/down */
        .lesson-node:has(.lesson-ring.active) .lesson-label,
        .lesson-label-jump {
            display: inline-block;
            animation: startLabelFloat 2s ease-in-out infinite;
            transform-origin: bottom center;
        }

        .lesson-label {
            background: #1a2236;
            color: var(--ll-color, #a855f7);
            padding: 10px 24px;
            border-radius: 14px;
            font-size: 0.9em;
            font-weight: 900;
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 0;
            position: relative;
            box-shadow: 0 4px 0 rgba(0,0,0,0.5);
            border: 2px solid var(--ll-border, rgba(168,85,247,0.4));
            pointer-events: none;
        }
        /* Downward triangle pointer */
        .lesson-label::after {
            content: '';
            position: absolute;
            bottom: -12px; left: 50%;
            transform: translateX(-50%);
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid #1a2236;
        }
        .lesson-label-spacer {
            height: 12px;
        }

        /* Hide START label + spacer while popup is open */
        body.lesson-popup-open .lesson-label,
        body.lesson-popup-open .lesson-label-spacer {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s ease;
        }
        .lesson-label, .lesson-label-spacer {
            transition: opacity 0.15s ease;
        }

        /* ── Lesson tap popup (Duolingo-style card) ── */
        #lesson-popup-backdrop {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 200;
        }
        #lesson-popup-backdrop.visible { display: block; }

        #lesson-popup {
            position: absolute;
            /* top/left set by JS */
            z-index: 201;
            width: min(300px, calc(100vw - 32px));
            background: var(--popup-color, #9333ea);
            border-radius: 20px;
            padding: 22px 20px 18px;
            box-shadow: 0 8px 0 var(--popup-shadow, #6b21a8), 0 12px 32px rgba(0,0,0,0.45);
            opacity: 0;
            pointer-events: none;
            transform: translateY(8px);
            transition: opacity 0.18s ease, transform 0.22s cubic-bezier(0.34,1.3,0.64,1);
        }
        #lesson-popup.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        /* Arrow pointing UP toward the ring — position set via --arrow-left */
        #lesson-popup::before {
            content: '';
            position: absolute;
            top: -10px;
            left: var(--arrow-left, 50%);
            transform: translateX(-50%);
            border-left: 11px solid transparent;
            border-right: 11px solid transparent;
            border-bottom: 11px solid var(--popup-color, #9333ea);
        }
        #lesson-popup-title {
            font-size: 1.18em;
            font-weight: 800;
            color: #fff;
            margin-bottom: 4px;
            line-height: 1.25;
        }
        #lesson-popup-sub {
            font-size: 0.88em;
            font-weight: 600;
            color: rgba(255,255,255,0.82);
            margin-bottom: 16px;
        }
        #lesson-popup-start {
            width: 100%;
            background: #fff;
            color: var(--popup-color, #6d28d9);
            border: none;
            border-radius: 14px;
            padding: 14px 0;
            font-size: 1em;
            font-weight: 900;
            letter-spacing: 1.5px;
            cursor: pointer;
            box-shadow: 0 4px 0 rgba(0,0,0,0.18);
            transition: transform 0.1s, box-shadow 0.1s;
        }
        #lesson-popup-start:active {
            transform: translateY(3px);
            box-shadow: 0 1px 0 rgba(0,0,0,0.12);
        }

        .lesson-type {
            margin-top: 10px;
            font-size: 0.83em;
            color: var(--text-secondary);
            font-weight: 600;
            text-align: center;
            max-width: 130px;
        }

        /* Bear island — floats beside the node */
        .mascot-island {
            position: absolute;
            font-size: 52px;
            animation: float 3s ease-in-out infinite;
            filter: drop-shadow(0 4px 10px rgba(0,0,0,0.45));
            pointer-events: none;
            top: 4px;
        }
        .path-offset-right  .mascot-island { left: -75px; }
        .path-offset-left   .mascot-island { right: -75px; }
        .path-offset-center .mascot-island { left: -85px; }

        /* Unit complete / checkpoint */
        .unit-review-node {
            width: 96px;
            height: 96px;
            background: linear-gradient(155deg, #3a4152, #252d3d);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.4em;
            cursor: default;
            box-shadow: 0 7px 0 #0d1117, 0 10px 24px rgba(0,0,0,0.4);
            transition: transform 0.15s, box-shadow 0.15s;
            position: relative;
            overflow: hidden;
            opacity: 0.7;
        }
        .unit-review-node::before {
            display: none;
        }
        .unit-review-node svg {
            opacity: 0.45;
            filter: grayscale(1) brightness(0.7);
        }

        /* Completed unit trophy — bright golden */
        .unit-review-node.completed {
            background: linear-gradient(155deg, #fbbf24, #f59e0b, #d97706);
            opacity: 1;
            box-shadow: 0 7px 0 #92400e, 0 10px 24px rgba(245,158,11,0.4), 0 0 30px rgba(251,191,36,0.3);
            overflow: visible;
        }
        .unit-review-node.completed svg {
            opacity: 1;
            filter: none;
            color: #fff;
            fill: #fff;
        }

        /* Particle container */
        .trophy-particles {
            position: absolute;
            inset: -20px;
            pointer-events: none;
        }
        .trophy-particle {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            animation: trophy-sparkle 2s ease-in-out infinite;
        }
        .trophy-particle:nth-child(1)  { top: 10%; left: -10%; background: #fbbf24; animation-delay: 0s; }
        .trophy-particle:nth-child(2)  { top: 50%; left: -15%; background: #f59e0b; animation-delay: 0.4s; }
        .trophy-particle:nth-child(3)  { top: 80%; left: -8%;  background: #fcd34d; animation-delay: 0.8s; }
        .trophy-particle:nth-child(4)  { top: 10%; right: -10%; left: auto; background: #f59e0b; animation-delay: 0.2s; }
        .trophy-particle:nth-child(5)  { top: 50%; right: -15%; left: auto; background: #fbbf24; animation-delay: 0.6s; }
        .trophy-particle:nth-child(6)  { top: 80%; right: -8%;  left: auto; background: #fcd34d; animation-delay: 1.0s; }
        .trophy-particle:nth-child(7)  { top: -5%; left: 30%;  background: #fde68a; animation-delay: 0.3s; width: 4px; height: 4px; }
        .trophy-particle:nth-child(8)  { top: -5%; right: 30%; left: auto; background: #fde68a; animation-delay: 0.7s; width: 4px; height: 4px; }

        @keyframes trophy-sparkle {
            0%, 100% { opacity: 0; transform: scale(0) translateY(0); }
            30% { opacity: 1; transform: scale(1.2) translateY(-6px); }
            60% { opacity: 0.8; transform: scale(0.8) translateY(-12px); }
            80% { opacity: 0; transform: scale(0.3) translateY(-18px); }
        }

        /* Simple dot spacer between nodes — no sticks */
        .path-connector {
            width: 6px;
            height: 6px;
            background: #4b5563;
            border-radius: 50%;
            margin: 10px 0;
            opacity: 0.6;
        }
        .path-connector.completed {
            background: var(--primary);
            opacity: 0.8;
        }

        /* Remove diagonal connector entirely */
        .path-connector-diagonal {
            width: 6px;
            height: 6px;
            background: #4b5563;
            border-radius: 50%;
            margin: 10px 0;
            opacity: 0.6;
            transform: none !important;
        }
        .path-connector-diagonal.completed {
            background: var(--primary);
            opacity: 0.8;
        }

        /* Curriculum summary card */
        .curriculum-summary {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
        }

        .summary-stat {
            text-align: center;
        }

        .summary-stat-value {
            font-size: 2em;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .summary-stat-label {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        @media (max-width: 768px) {
            .mascot-node {
                display: none;
            }

            .lesson-path {
                padding: 20px 10px;
            }

            .unit-header {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }
        }
        /* Lottie completion overlay */
        #lottie-overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: rgba(10, 10, 30, 0.82);
            backdrop-filter: blur(8px);
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: all;
            gap: 0;
        }
        #lottie-overlay.visible {
            display: flex;
        }
        #lottie-player-wrap {
            position: fixed;
            inset: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
        }
        #lottie-player-wrap dotlottie-player {
            width: 100%;
            height: 100%;
        }
        /* floating praise words */
        .lottie-praise {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 1;
        }
        .lottie-word {
            position: absolute;
            font-weight: 800;
            border-radius: 40px;
            padding: 6px 18px;
            white-space: nowrap;
            opacity: 0;
            transform: scale(0.4) translateY(20px);
            animation: lottieWordPop 0.55s cubic-bezier(0.34,1.56,0.64,1) forwards;
        }
        @keyframes lottieWordPop {
            0%   { opacity: 0; transform: scale(0.4) translateY(20px); }
            60%  { opacity: 1; transform: scale(1.12) translateY(-4px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }
        #lottie-main-label {
            font-size: 2em;
            font-weight: 900;
            color: #fff;
            letter-spacing: -0.5px;
            margin-top: 4px;
            text-align: center;
            opacity: 0;
            transform: translateY(16px) scale(0.85);
            transition: opacity 0.45s ease, transform 0.45s cubic-bezier(0.34,1.56,0.64,1);
            position: relative;
            z-index: 2;
        }
        #lottie-main-label.pop {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
        #lottie-sub-label {
            font-size: 1em;
            color: rgba(255,255,255,0.6);
            margin-top: 6px;
            text-align: center;
            opacity: 0;
            transition: opacity 0.4s ease 0.3s;
            position: relative;
            z-index: 2;
        }
        #lottie-sub-label.pop {
            opacity: 1;
        }
        #lottie-continue-btn {
            margin-top: 32px;
            padding: 16px 52px;
            border-radius: 16px;
            border: none;
            background: linear-gradient(135deg, #9333ea, #7c3aed);
            color: #fff;
            font-size: 1.1em;
            font-weight: 800;
            cursor: pointer;
            letter-spacing: 0.3px;
            box-shadow: 0 6px 28px rgba(147,51,234,0.45);
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.4s ease 0.55s, transform 0.4s cubic-bezier(0.34,1.56,0.64,1) 0.55s,
                        background 0.2s, box-shadow 0.2s;
            position: relative;
            z-index: 2;
        }
        #lottie-continue-btn.pop {
            opacity: 1;
            transform: translateY(0);
        }
        #lottie-continue-btn:hover {
            background: linear-gradient(135deg, #9333ea, #9333ea);
            box-shadow: 0 8px 36px rgba(147,51,234,0.6);
        }

        /* ── Speech Practice ───────────────────────────── */
        .sp-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 12px auto 0;
            padding: 10px 22px;
            background: transparent;
            border: 2px solid var(--primary);
            border-radius: 50px;
            color: var(--primary);
            font-size: 0.92em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .sp-btn:hover { background: rgba(147,51,234,0.12); }
        .sp-btn svg { flex-shrink: 0; }

        /* Overlay backdrop */
        #sp-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            align-items: flex-end;
            justify-content: center;
        }
        #sp-overlay.open { display: flex; }

        /* Bottom sheet panel */
        #sp-panel {
            background: var(--bg-card);
            border-radius: 24px 24px 0 0;
            width: 100%;
            max-width: 480px;
            padding: 24px 24px 36px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            animation: sp-slide-up 0.28s ease;
        }
        @keyframes sp-slide-up {
            from { transform: translateY(100%); }
            to   { transform: translateY(0); }
        }

        .sp-handle {
            width: 40px; height: 4px;
            background: var(--border-color);
            border-radius: 4px;
            margin-bottom: 4px;
        }

        .sp-word {
            font-size: 1.6em;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: 0.02em;
        }

        /* Mic button */
        .sp-mic {
            width: 80px; height: 80px;
            border-radius: 50%;
            border: none;
            background: var(--primary);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 16px rgba(147,51,234,0.4);
            position: relative;
        }
        .sp-mic:hover { transform: scale(1.06); }
        .sp-mic.recording {
            background: var(--error);
            box-shadow: 0 0 0 0 rgba(255,75,75,0.6);
            animation: sp-pulse 1.2s infinite;
        }
        @keyframes sp-pulse {
            0%   { box-shadow: 0 0 0 0 rgba(255,75,75,0.6); }
            70%  { box-shadow: 0 0 0 16px rgba(255,75,75,0); }
            100% { box-shadow: 0 0 0 0 rgba(255,75,75,0); }
        }

        .sp-hint {
            font-size: 0.82em;
            color: var(--text-secondary);
            text-align: center;
        }

        /* Score area */
        #sp-result { width: 100%; display: none; flex-direction: column; gap: 12px; }
        #sp-result.visible { display: flex; }

        .sp-overall {
            text-align: center;
            font-size: 2.4em;
            font-weight: 800;
            line-height: 1;
        }
        .sp-overall-label {
            text-align: center;
            font-size: 0.8em;
            color: var(--text-secondary);
            margin-top: -6px;
        }

        /* Per-word bars */
        .sp-words { display: flex; flex-direction: column; gap: 10px; width: 100%; }
        .sp-word-row {
            display: grid;
            grid-template-columns: 80px 1fr 36px;
            align-items: center;
            gap: 10px;
        }
        .sp-word-label {
            font-size: 0.95em;
            font-weight: 700;
            color: var(--text-primary);
            text-align: right;
        }
        .sp-bar-wrap {
            height: 10px;
            background: var(--progress-bg, #2d3748);
            border-radius: 6px;
            overflow: hidden;
        }
        .sp-bar-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.6s cubic-bezier(0.4,0,0.2,1);
        }
        .sp-word-score {
            font-size: 0.88em;
            font-weight: 700;
            text-align: left;
        }

        .sp-close-btn {
            margin-top: 8px;
            width: 100%;
            padding: 16px 0;
            border-radius: 50px;
            border: none;
            background: var(--primary);
            color: #fff;
            font-size: 1em;
            font-weight: 800;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            box-shadow: 0 4px 0 rgba(0,0,0,0.25);
        }
        .sp-close-btn:hover { background: var(--primary-hover); }
        .sp-close-btn:active { transform: translateY(3px); box-shadow: 0 1px 0 rgba(0,0,0,0.2); }
    </style>
    <script src="https://unpkg.com/@dotlottie/player-component@2.7.12/dist/dotlottie-player.mjs" type="module"></script>
    <script src="https://js.puter.com/v2/"></script>
    <style>
        /* Double-click translate popup */
        .translate-popup {
            position: fixed;
            z-index: 10000;
            background: #1e293b;
            border: 1.5px solid #7c3aed;
            border-radius: 12px;
            padding: 10px 14px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.5), 0 0 12px rgba(124,58,237,0.2);
            pointer-events: auto;
            animation: tp-in 0.18s ease;
            max-width: 260px;
            min-width: 120px;
        }
        @keyframes tp-in {
            from { opacity: 0; transform: translateY(6px) scale(0.95); }
            to   { opacity: 1; transform: translateY(0) scale(1); }
        }
        .translate-popup::before {
            content: '';
            position: absolute;
            top: -6px;
            left: var(--tp-arrow, 50%);
            transform: translateX(-50%) rotate(45deg);
            width: 10px; height: 10px;
            background: #1e293b;
            border-left: 1.5px solid #7c3aed;
            border-top: 1.5px solid #7c3aed;
        }
        .tp-word {
            font-weight: 700;
            color: #a78bfa;
            font-size: 1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tp-speak {
            background: none;
            border: none;
            cursor: pointer;
            color: #a78bfa;
            padding: 2px;
            display: flex;
            border-radius: 4px;
        }
        .tp-speak:hover { color: #c4b5fd; }
        .tp-divider {
            height: 1px;
            background: #334155;
            margin: 6px 0;
        }
        .tp-translation {
            color: #e2e8f0;
            font-size: 0.9em;
            line-height: 1.4;
        }
        .tp-lang {
            font-size: 0.7em;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }
        .tp-loading {
            color: #94a3b8;
            font-size: 0.85em;
            font-style: italic;
        }
    </style>
</head>
<body>
    <!-- Correct answer fullscreen overlay -->
    <div id="tq-correct-overlay">
        <dotlottie-player id="tq-correct-player"
            src="assets/congratulations (1).lottie"
            autoplay
            speed="1.5">
        </dotlottie-player>
    </div>

    <!-- Speech practice overlay -->
    <div id="sp-overlay" onclick="spOverlayClick(event)">
        <div id="sp-panel">
            <div class="sp-handle"></div>
            <div class="sp-word" id="sp-word-label"></div>

            <button class="sp-mic" id="sp-mic-btn" onclick="spToggleRecording()">
                <!-- Mic icon -->
                <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 14a3 3 0 0 0 3-3V5a3 3 0 0 0-6 0v6a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 6 6.93V20H9v2h6v-2h-2v-2.07A7 7 0 0 0 19 11h-2z"/>
                </svg>
            </button>
            <div class="sp-hint" id="sp-hint">Tap the mic and say the word</div>

            <!-- Results section (hidden until evaluated) -->
            <div id="sp-result">
                <div class="sp-overall" id="sp-overall-score"></div>
                <div class="sp-overall-label">pronunciation score</div>
                <div class="sp-words" id="sp-words-list"></div>
                <button class="sp-close-btn" onclick="spClose()">Done</button>
            </div>
        </div>
    </div>

    <!-- Lesson tap popup (Duolingo-style) -->
    <div id="lesson-popup-backdrop" onclick="closeLessonPopup()"></div>
    <div id="lesson-popup">
        <div id="lesson-popup-title">Lesson</div>
        <div id="lesson-popup-sub">Lesson 1 of 4</div>
        <button id="lesson-popup-start" onclick="window._lessonPopupStart && window._lessonPopupStart()">START</button>
    </div>

    <!-- Lottie completion overlay -->
    <div id="lottie-overlay">
        <div id="lottie-player-wrap">
            <dotlottie-player id="lottie-player" src="assets/finish (2).lottie" autoplay loop speed="1"></dotlottie-player>
            <div class="lottie-praise" id="lottie-praise"></div>
        </div>
        <div id="lottie-main-label">Well done!</div>
        <div id="lottie-sub-label">Keep it up!</div>
        <button id="lottie-continue-btn" onclick="window._lottieContinue && window._lottieContinue()">Continue</button>
    </div>

    <div class="app-container">
        <div class="header">
            <h1>Zehn AI</h1>
            <div class="header-right">
                <div class="breadcrumb" id="breadcrumb"></div>
                <button class="debug-toggle-btn" onclick="toggleDebugConsole()">
                    <span id="debug-toggle-text">Debug</span>
                </button>
            </div>
        </div>

        <div class="content">
            <!-- Home Page -->
            <div id="page-home" class="page active">
                <!-- Landing Hero Section (shown when not logged in) -->
                <div id="landing-section">
                    <div class="landing-hero">
                        <h1 class="hero-title">Learn Languages with AI</h1>
                        <p class="hero-subtitle">Personalized curriculum powered by artificial intelligence, designed just for you</p>

                        <div class="hero-cta">
                            <button class="btn-large btn-primary-large" onclick="showSignupSection()">Get Started</button>
                            <button class="btn-large btn-secondary-large" onclick="showLoginSection()">Sign In</button>
                        </div>
                    </div>

                    <div class="divider"></div>

                    <!-- Features Section -->
                    <div class="features-section">
                        <h2 class="features-title">Why Choose Zehn AI?</h2>

                        <div class="features-grid">
                            <div class="feature-card">
                                <span class="feature-icon">🤖</span>
                                <h3 class="feature-title">AI-Powered Learning</h3>
                                <p class="feature-description">Our advanced AI creates a personalized curriculum tailored to your level, goals, and interests</p>
                            </div>

                            <div class="feature-card">
                                <span class="feature-icon">📚</span>
                                <h3 class="feature-title">Comprehensive Content</h3>
                                <p class="feature-description">Master vocabulary through flashcards, stories, and interactive tests designed for retention</p>
                            </div>

                            <div class="feature-card">
                                <span class="feature-icon">📊</span>
                                <h3 class="feature-title">Track Your Progress</h3>
                                <p class="feature-description">Monitor your learning journey with detailed progress tracking and completion statistics</p>
                            </div>

                            <div class="feature-card">
                                <span class="feature-icon">🎯</span>
                                <h3 class="feature-title">Goal-Oriented</h3>
                                <p class="feature-description">Learn what matters to you - whether it's travel, career, education, or personal growth</p>
                            </div>

                            <div class="feature-card">
                                <span class="feature-icon">🌍</span>
                                <h3 class="feature-title">Multiple Languages</h3>
                                <p class="feature-description">Learn English with support for speakers of Russian, Spanish, French, Arabic, and more</p>
                            </div>

                            <div class="feature-card">
                                <span class="feature-icon">⚡</span>
                                <h3 class="feature-title">Adaptive Learning</h3>
                                <p class="feature-description">Content adapts to your proficiency level from beginner (A1) to advanced (C2)</p>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Main Actions (hidden until authenticated) -->
                <div id="main-actions" style="display: none;">
                    <div class="landing-hero">
                        <h1 class="hero-title" style="font-size: 2.5em;">Welcome Back!</h1>
                        <p class="hero-subtitle">Ready to continue your learning journey?</p>

                        <div class="hero-cta">
                            <button class="btn-large btn-primary-large" onclick="loadCurriculum(); return false;">View My Curriculum</button>
                            <button class="btn-large btn-secondary-large" onclick="startOnboarding(); return false;">Create New Curriculum</button>
                        </div>

                        <div style="margin-top: 30px;">
                            <button type="button" class="btn-secondary" onclick="logout(); return false;">Logout</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Onboarding Page -->
            <div id="page-onboarding" class="page">
                <div class="section-title">Answer a few questions 📝</div>
                <div id="onboarding-content"></div>
            </div>

            <!-- Curriculum Page -->
            <div id="page-curriculum" class="page">
                <div id="curriculum-info"></div>
                <div id="units-grid"></div>
            </div>

            <!-- Unit Details Page -->
            <div id="page-unit" class="page">
                <!-- Sentinel for IntersectionObserver - sits above sticky header -->
                <div id="unit-header-sentinel" style="height:1px;margin-top:-1px;pointer-events:none;"></div>
                <!-- Sticky unit header wrapper -->
                <div id="unit-description-sticky">
                    <div id="unit-title" style="display:none;"></div>
                    <div id="unit-description"></div>
                </div>
                <!-- Spacer that fills gap when header becomes sticky -->
                <div id="unit-header-spacer"></div>
                <div id="sections-container"></div>
            </div>

            <!-- Lesson Page -->
            <div id="page-lesson" class="page">
                <button onclick="backToUnit()" class="fc-back-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
                    Curriculum
                </button>
                <div class="section-title" id="lesson-title"></div>
                <div id="lesson-content"></div>
            </div>

            <!-- Progress Page -->
            <div id="page-progress" class="page">
                <div class="section-title">Your Progress 📊</div>
                <div id="progress-stats"></div>
                <div id="progress-details"></div>
            </div>
        </div>

        <!-- Auth Modal Overlay -->
        <div class="auth-overlay" id="auth-overlay">
            <div class="auth-modal">
                <button class="auth-close" onclick="closeAuthModal()">✕</button>
                <button class="auth-signup-btn" id="auth-mode-toggle" onclick="authToggleMode()">SIGN UP</button>

                <h2 id="auth-modal-title">Log in</h2>

                <!-- Step 1: Email -->
                <div id="login-form">
                    <input type="email" id="email-address" class="auth-input" placeholder="Email address">
                    <button type="button" class="auth-submit-btn" id="send-otp-btn" onclick="sendOTP()">Send OTP</button>
                </div>

                <!-- Step 2: OTP -->
                <div id="otp-form" style="display: none;">
                    <p class="auth-otp-hint">We sent a code to <strong id="otp-email-display"></strong></p>
                    <div class="input-wrapper">
                        <input type="text" id="otp-code" class="auth-input" placeholder="Enter OTP code" maxlength="6" onkeypress="if(event.key==='Enter'){verifyOTP();}">
                    </div>
                    <button type="button" class="auth-submit-btn" onclick="verifyOTP()" id="otp-verify-btn">LOG IN</button>
                    <button type="button" class="btn-secondary" onclick="showLoginForm()" style="width:100%;margin-top:8px;">← Back</button>
                </div>

                <!-- Step 3: Profile completion (sign up only) -->
                <div id="profile-form" style="display: none;">
                    <p class="auth-otp-hint">Almost there! Tell us about yourself.</p>
                    <input type="text" id="profile-firstname" class="auth-input" placeholder="First name" style="margin-bottom:10px;">
                    <input type="text" id="profile-lastname" class="auth-input" placeholder="Last name" style="margin-bottom:10px;">
                    <input type="text" id="profile-username" class="auth-input" placeholder="Username" style="margin-bottom:10px;">
                    <input type="number" id="profile-age" class="auth-input" placeholder="Age" min="5" max="120" style="margin-bottom:10px;">
                    <button type="button" class="auth-submit-btn" onclick="submitProfile()">Get Started</button>
                </div>

                <div class="auth-divider" id="auth-divider"><span>OR</span></div>

                <div class="auth-social-btns" id="auth-social-btns">
                    <button class="auth-social-btn" onclick="alert('Google login coming soon!')">
                        <svg width="20" height="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                            <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                            <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                            <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                        </svg>
                        GOOGLE
                    </button>
                    <button class="auth-social-btn" onclick="alert('Apple login coming soon!')">
                        <svg width="20" height="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.8-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z" fill="currentColor"/>
                        </svg>
                        APPLE
                    </button>
                </div>

                <div class="auth-footer" id="auth-footer">
                    By signing in to Zehn AI, you agree to our <a href="#">Terms</a> and <a href="#">Privacy Policy</a>.
                </div>
            </div>
        </div>

        <!-- Guidebook Modal -->
        <div class="guidebook-overlay" id="guidebook-overlay" onclick="closeGuidebook(event)">
            <div class="guidebook-modal">
                <div class="guidebook-header">
                    <div class="guidebook-header-left">
                        <div>
                            <div class="guidebook-unit-label" id="guidebook-unit-label">UNIT 1</div>
                            <div class="guidebook-title" id="guidebook-title">Guidebook</div>
                            <div class="guidebook-subtitle" id="guidebook-subtitle">What you'll learn in this unit</div>
                        </div>
                    </div>
                    <button class="guidebook-close" onclick="closeGuidebook()">✕</button>
                </div>
                <div class="guidebook-body" id="guidebook-body">
                    <div class="guidebook-loading">
                        <div class="spinner"></div>
                        <p>Loading guidebook...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Debug Console -->
        <div class="debug-console hidden" id="debug-console">
            <div class="debug-header">
                <strong>🔍 Debug Console</strong>
                <button onclick="clearDebugLogs()" class="btn-secondary">Clear Logs</button>
            </div>
            <div id="debug-logs"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5505/v1/personalized-learning/course';
        const AUTH_BASE = 'http://localhost:5505/v1/users';
        const SPEECH_BASE = 'http://localhost:5505/v1/speech';
        const FRONT_USER_BASE = 'http://localhost:5505/v1/front-users';
        let isAuthenticated = false;

        // Debug logging functions
        function debugLog(message, type = 'info') {
            try {
                const debugLogs = document.getElementById('debug-logs');
                if (!debugLogs) return;

                const timestamp = new Date().toLocaleTimeString();
                const log = document.createElement('div');
                log.className = `log ${type}`;
                log.innerHTML = `<strong>[${timestamp}]</strong> ${typeof message === 'object' ? JSON.stringify(message, null, 2) : message}`;
                debugLogs.appendChild(log);
                debugLogs.scrollTop = debugLogs.scrollHeight;

                // Also log to browser console
                console.log(`[${type.toUpperCase()}]`, message);
            } catch (e) {
                console.error('Debug log error:', e);
            }
        }

        function clearDebugLogs() {
            const debugLogs = document.getElementById('debug-logs');
            if (debugLogs) debugLogs.innerHTML = '';
        }

        function toggleDebugConsole() {
            const debugConsole = document.getElementById('debug-console');
            const toggleText = document.getElementById('debug-toggle-text');

            if (debugConsole.classList.contains('hidden')) {
                debugConsole.classList.remove('hidden');
                toggleText.textContent = '🔍 Hide Debug';
            } else {
                debugConsole.classList.add('hidden');
                toggleText.textContent = '🔍 Show Debug';
            }
        }

        // Prevent page reload on any errors
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            debugLog(`JavaScript Error: ${msg} at ${url}:${lineNo}:${columnNo}`, 'error');
            if (error) debugLog(error.stack, 'error');
            return true; // Prevent default error handling
        };

        window.addEventListener('unhandledrejection', function(event) {
            debugLog(`Unhandled Promise Rejection: ${event.reason}`, 'error');
            event.preventDefault(); // Prevent page reload
        });

        // Prevent page reload on beforeunload
        window.addEventListener('beforeunload', function(event) {
            debugLog('⚠️ Page trying to reload - prevented!', 'warn');
            event.preventDefault();
            event.returnValue = '';
        });

        // State management
        let appState = {
            currentPage: 'home',
            curriculum: null,
            currentUnit: null,
            currentLesson: null,
            onboardingQuestions: null,
            onboardingAnswers: {},
            completedLessons: [],
            completedSections: [],
            lessonSections: {}, // lessonId -> { flashcard: sectionId, story: sectionId, test: sectionId }
        };

        // Navigation
        function navigateTo(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(`page-${page}`).classList.add('active');
            appState.currentPage = page;
            window.scrollTo(0, 0);
            updateBreadcrumb();
            // Always close lesson popup when navigating away
            closeLessonPopup();
            // Disconnect sticky observer when leaving unit page
            if (page !== 'unit' && window._unitHeaderObserver) {
                window._unitHeaderObserver.disconnect();
                window._unitHeaderObserver = null;
                const sticky = document.getElementById('unit-description-sticky');
                const spacer = document.getElementById('unit-header-spacer');
                if (sticky) sticky.classList.remove('is-stuck');
                if (spacer) spacer.classList.remove('active');
            }
        }

        function updateBreadcrumb() {
            const breadcrumb = document.getElementById('breadcrumb');
            const paths = {
                home: '<a href="#" onclick="event.preventDefault(); navigateTo(\'home\')">Home</a>',
                onboarding: '<a href="#" onclick="event.preventDefault(); navigateTo(\'home\')">Home</a> > Onboarding',
                curriculum: '<a href="#" onclick="event.preventDefault(); navigateTo(\'home\')">Home</a> > <a href="#" onclick="event.preventDefault(); navigateTo(\'curriculum\')">Curriculum</a>',
                unit: '<a href="#" onclick="event.preventDefault(); navigateTo(\'home\')">Home</a> > <a href="#" onclick="event.preventDefault(); navigateTo(\'curriculum\')">Curriculum</a> > Unit',
                lesson: '<a href="#" onclick="event.preventDefault(); navigateTo(\'home\')">Home</a> > <a href="#" onclick="event.preventDefault(); loadCurriculum()">Curriculum</a> > Lesson',
                progress: '<a href="#" onclick="event.preventDefault(); navigateTo(\'home\')">Home</a> > Progress',
            };
            breadcrumb.innerHTML = paths[appState.currentPage] || '';
        }

        // Set cookies for authentication
        function setCookie(name, value, days = 1) {
            // For file:// protocol, we can't set cookies
            // User needs to set them manually via browser console
            if (window.location.protocol === 'file:') {
                debugLog(`⚠️ Cannot set cookies from file:// protocol`, 'warn');
                debugLog(`Please set cookies manually in browser console:`, 'warn');
                debugLog(`document.cookie = "${name}=${value}; path=/"`, 'warn');
                return;
            }

            const expires = new Date();
            expires.setTime(expires.getTime() + days * 24 * 60 * 60 * 1000);
            document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/;domain=localhost`;
            debugLog(`🍪 Set cookie: ${name} = ${value.substring(0, 20)}...`, 'info');

            // Verify cookie was set
            const allCookies = document.cookie;
            debugLog(`All cookies: ${allCookies}`, 'info');

            if (!allCookies.includes(name)) {
                debugLog(`⚠️ Warning: Cookie ${name} was not set!`, 'warn');
            }
        }

        // Helper function to extract ID from various formats
        function extractId(idObj) {
            if (!idObj) return null;
            if (typeof idObj === 'string') return idObj;
            if (idObj.$oid) return idObj.$oid;
            if (idObj.toString && typeof idObj.toString === 'function') {
                const str = idObj.toString();
                if (str !== '[object Object]') return str;
            }
            // For Buffer objects, try to extract from the original object
            return null;
        }

        // Audio player
        let currentAudio = null;
        let storyAudio = null;
        let storyTranscript = [];
        let highlightInterval = null;

        // Pre-load answer sound effects
        const correctSound = new Audio('assets/correct.mp3');
        const wrongSound = new Audio('assets/wrong.mp3');
        function playCorrectSound() { correctSound.currentTime = 0; correctSound.play().catch(() => {}); }
        function playWrongSound() { wrongSound.currentTime = 0; wrongSound.play().catch(() => {}); }

        function playAudio(audioUrl) {
            debugLog(`Playing audio: ${audioUrl}`, 'info');

            // Stop current audio if playing
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }

            // Create and play new audio
            currentAudio = new Audio(audioUrl);
            currentAudio.play().catch(error => {
                debugLog(`Failed to play audio: ${error.message}`, 'error');
                showToast('Failed to play audio', 'error');
            });
        }

        function playStoryWithHighlight(audioUrl) {
            // Use globally stored transcript
            const transcript = window.currentStoryTranscript || [];

            debugLog(`Playing story with ${transcript.length} transcript entries`, 'info');

            // Stop previous story audio if any
            if (storyAudio) {
                storyAudio.pause();
                storyAudio = null;
            }

            // Clear any existing highlights
            document.querySelectorAll('.story-word.highlighted').forEach(el => {
                el.classList.remove('highlighted');
            });

            // Store transcript data
            storyTranscript = transcript;

            // Create and configure audio
            storyAudio = new Audio(audioUrl);

            // Update buttons
            document.getElementById('play-story-btn').style.display = 'none';
            document.getElementById('pause-story-btn').style.display = 'flex';

            // Listen to time updates for word highlighting
            storyAudio.addEventListener('timeupdate', () => {
                const currentTime = storyAudio.currentTime * 1000; // Convert to milliseconds

                // Find which word should be highlighted based on current time
                storyTranscript.forEach((entry, index) => {
                    const wordElement = document.querySelector(`[data-word-index="${index}"]`);

                    if (wordElement) {
                        // Check if current time is within this word's time range
                        if (currentTime >= entry.audioStartAt && currentTime <= entry.audioEndAt) {
                            // Highlight current word
                            if (!wordElement.classList.contains('highlighted')) {
                                wordElement.classList.add('highlighted');
                            }
                        } else {
                            // Remove highlight from words not currently playing
                            wordElement.classList.remove('highlighted');
                        }
                    }
                });
            });

            // When audio ends, reset UI
            storyAudio.addEventListener('ended', () => {
                document.getElementById('play-story-btn').style.display = 'flex';
                document.getElementById('pause-story-btn').style.display = 'none';

                // Remove all highlights
                document.querySelectorAll('.story-word.highlighted').forEach(el => {
                    el.classList.remove('highlighted');
                });
            });

            // Play the audio
            storyAudio.play().catch(error => {
                debugLog(`Failed to play story audio: ${error.message}`, 'error');
                showToast('Failed to play story audio', 'error');
                document.getElementById('play-story-btn').style.display = 'flex';
                document.getElementById('pause-story-btn').style.display = 'none';
            });
        }

        function pauseStoryAudio() {
            if (storyAudio) {
                storyAudio.pause();

                // Update buttons
                document.getElementById('play-story-btn').style.display = 'flex';
                document.getElementById('pause-story-btn').style.display = 'none';

                debugLog('Story audio paused', 'info');
            }
        }

        // Check if user is authenticated
        function checkAuth() {
            const cookies = document.cookie;
            debugLog(`🍪 Current cookies: ${cookies}`, 'info');

            // Check for m_at (my_access_token) and m_did (my_device_id)
            const hasAccessToken = cookies.includes('m_at=');
            const hasDeviceId = cookies.includes('m_did=');

            debugLog(`Has m_at (access_token): ${hasAccessToken}`, 'info');
            debugLog(`Has m_did (device_id): ${hasDeviceId}`, 'info');

            isAuthenticated = hasAccessToken && hasDeviceId;

            debugLog(`isAuthenticated: ${isAuthenticated}`, 'info');

            if (isAuthenticated) {
                debugLog('✅ User is authenticated - showing main actions', 'info');
                document.getElementById('landing-section').style.display = 'none';
                document.getElementById('auth-overlay').classList.remove('active');
                document.getElementById('main-actions').style.display = 'block';
            } else {
                debugLog('❌ User not authenticated - showing landing page', 'warn');
                document.getElementById('landing-section').style.display = 'block';
                document.getElementById('auth-overlay').classList.remove('active');
                document.getElementById('main-actions').style.display = 'none';
            }
        }

        // Auth mode state: 'login' | 'signup'
        let authMode = 'login';
        let authUserId = null; // set after OTP verify, used for profile update
        let isNewUser = false; // determined by checking DB before OTP

        function authToggleMode() {
            authMode = authMode === 'login' ? 'signup' : 'login';
            const isSignup = authMode === 'signup';
            document.getElementById('auth-modal-title').textContent = isSignup ? 'Sign up' : 'Log in';
            document.getElementById('auth-mode-toggle').textContent = isSignup ? 'LOG IN' : 'SIGN UP';
            document.getElementById('otp-verify-btn').textContent = isSignup ? 'VERIFY' : 'LOG IN';
            document.getElementById('send-otp-btn').textContent = isSignup ? 'VERIFY' : 'Send OTP';
            document.getElementById('send-otp-btn').disabled = false;
            // Reset to email step
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('otp-form').style.display = 'none';
            document.getElementById('profile-form').style.display = 'none';
            document.getElementById('auth-divider').style.display = '';
            document.getElementById('auth-social-btns').style.display = '';
            document.getElementById('email-address').value = '';
            document.getElementById('otp-code').value = '';
        }

        // Track front user (fire-and-forget)
        async function trackFrontUser(data) {
            try {
                await fetch(`${FRONT_USER_BASE}/track`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(data),
                });
                debugLog('Front user tracked: ' + data.email, 'info');
            } catch (e) {
                debugLog('Front user tracking failed: ' + e.message, 'warn');
            }
        }

        // Auth functions
        async function sendOTP() {
            const email = document.getElementById('email-address').value.trim();

            if (!email) {
                showToast('Please enter email address', 'error');
                return;
            }

            const otpBtn = document.getElementById('send-otp-btn');
            otpBtn.classList.remove('pressed');
            void otpBtn.offsetWidth;
            otpBtn.classList.add('pressed');
            const originalText = otpBtn.textContent;
            otpBtn.textContent = 'Sending...';
            otpBtn.disabled = true;

            debugLog(`Sending OTP to ${email}`, 'info');

            try {
                // Step 1: Check if user exists in DB (non-blocking)
                try {
                    const existsRes = await fetch(`${AUTH_BASE}/exists`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ email }),
                    });
                    if (existsRes.ok) {
                        const existsData = await existsRes.json();
                        isNewUser = !existsData.data?.isRegistered;
                    } else {
                        isNewUser = true;
                    }
                } catch (e) {
                    debugLog(`Exists check failed: ${e.message}, defaulting to new user`, 'warn');
                    isNewUser = true;
                }

                // Update UI based on whether user exists
                if (isNewUser) {
                    authMode = 'signup';
                    document.getElementById('auth-modal-title').textContent = 'Sign up';
                    document.getElementById('auth-mode-toggle').textContent = 'LOG IN';
                    document.getElementById('otp-verify-btn').textContent = 'VERIFY';
                } else {
                    authMode = 'login';
                    document.getElementById('auth-modal-title').textContent = 'Log in';
                    document.getElementById('auth-mode-toggle').textContent = 'SIGN UP';
                    document.getElementById('otp-verify-btn').textContent = 'LOG IN';
                }

                debugLog(`User exists: ${!isNewUser}, mode set to: ${authMode}`, 'info');

                // Step 2: Send OTP
                debugLog(`Calling login-with-otp for ${email}...`, 'info');
                const response = await fetch(`${AUTH_BASE}/login-with-otp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ email }),
                });

                debugLog(`login-with-otp response status: ${response.status}`, 'info');

                const contentType = response.headers.get('content-type');
                let data;
                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                    debugLog(`login-with-otp response: ${JSON.stringify(data)}`, 'info');
                } else {
                    const text = await response.text();
                    debugLog(`login-with-otp non-JSON response: ${text}`, 'error');
                    throw new Error('Server returned non-JSON response');
                }

                if (response.ok) {
                    showToast('OTP sent! Check your email.', 'success');
                    document.getElementById('otp-email-display').textContent = email;
                    document.getElementById('login-form').style.display = 'none';
                    document.getElementById('otp-form').style.display = 'block';
                    document.getElementById('auth-divider').style.display = 'none';
                    document.getElementById('auth-social-btns').style.display = 'none';
                } else {
                    const errorMsg = data.error?.code || data.error?.message || data.message || 'Failed to send OTP';
                    const blockedTime = data.error?.data?.blockedTime;
                    throw new Error(blockedTime ? `${errorMsg} (Wait ${blockedTime}s)` : errorMsg);
                }
            } catch (error) {
                debugLog(`Error sending OTP: ${error.message}`, 'error');
                showToast(error.message, 'error');
                otpBtn.textContent = originalText;
                otpBtn.disabled = false;
            }
        }

        async function verifyOTP() {
            const email = document.getElementById('email-address').value.trim();
            const code = document.getElementById('otp-code').value.trim();

            if (!code) { showToast('Please enter OTP code', 'error'); return; }

            try {
                const response = await fetch(`${AUTH_BASE}/verify-with-otp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ email, code }),
                });

                const data = await response.json();
                debugLog('Verify Response: ' + JSON.stringify(data), 'info');

                if (response.ok) {
                    isAuthenticated = true;

                    // Extract userId from token data if available
                    const user = data.data?.user || data.tokens?.user || null;
                    authUserId = user?._id || user?.id || null;

                    if (isNewUser) {
                        // New user — show profile completion step
                        document.getElementById('otp-form').style.display = 'none';
                        document.getElementById('profile-form').style.display = 'block';
                        document.getElementById('auth-footer').style.display = 'none';
                        document.getElementById('auth-mode-toggle').style.display = 'none';
                        // Try to get userId from current session if not in response
                        if (!authUserId) {
                            try {
                                const meRes = await fetch(`${AUTH_BASE}/me`, { credentials: 'include' });
                                if (meRes.ok) {
                                    const meData = await meRes.json();
                                    authUserId = meData.data?._id || meData.data?.id || meData._id || null;
                                }
                            } catch {}
                        }
                    } else {
                        // Returning user — go straight to app
                        trackFrontUser({ email });
                        showToast('Welcome back! 🎉', 'success');
                        closeAuthModal();
                        document.getElementById('email-address').value = '';
                        document.getElementById('otp-code').value = '';
                        checkAuth();
                    }
                } else {
                    throw new Error(data.message || 'Invalid OTP');
                }
            } catch (error) {
                debugLog(`❌ Error verifying OTP: ${error.message}`, 'error');
                showToast(error.message, 'error');
            }
        }

        async function submitProfile() {
            const firstName = document.getElementById('profile-firstname').value.trim();
            const lastName  = document.getElementById('profile-lastname').value.trim();
            const username  = document.getElementById('profile-username').value.trim();
            const ageValue  = document.getElementById('profile-age').value.trim();
            const age       = ageValue ? parseInt(ageValue, 10) : null;

            if (!firstName) { showToast('Please enter your first name', 'error'); return; }
            if (!lastName)  { showToast('Please enter your last name', 'error'); return; }
            if (!username)  { showToast('Please enter a username', 'error'); return; }
            if (!age || age < 5 || age > 120) { showToast('Please enter a valid age', 'error'); return; }

            try {
                const btn = document.querySelector('#profile-form .auth-submit-btn');
                btn.textContent = 'Saving...';
                btn.disabled = true;

                let saved = false;

                const profileData = { firstName, lastName, username, age };

                // Try to update user if we have their ID
                if (authUserId) {
                    const res = await fetch(`${AUTH_BASE}/${authUserId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(profileData),
                    });
                    saved = res.ok;
                    if (!saved) {
                        const err = await res.json().catch(() => ({}));
                        const msg = err.message || err.error?.message || '';
                        if (msg.toLowerCase().includes('username')) {
                            showToast('Username already taken, try another', 'error');
                            btn.textContent = 'Get Started';
                            btn.disabled = false;
                            return;
                        }
                    }
                }

                // Track front user with profile data
                const trackedEmail = document.getElementById('email-address').value.trim();
                trackFrontUser({ email: trackedEmail, firstName, lastName, username, age });

                showToast('Welcome to Zehn AI! 🎉', 'success');
                closeAuthModal();
                checkAuth();
            } catch (error) {
                debugLog(`Profile update error: ${error.message}`, 'error');
                showToast(error.message, 'error');
                const btn = document.querySelector('#profile-form .auth-submit-btn');
                if (btn) { btn.textContent = 'Get Started'; btn.disabled = false; }
            }
        }

        function showLoginSection() {
            authMode = 'login';
            document.getElementById('auth-modal-title').textContent = 'Log in';
            document.getElementById('auth-mode-toggle').textContent = 'SIGN UP';
            document.getElementById('otp-verify-btn').textContent = 'LOG IN';
            document.getElementById('send-otp-btn').textContent = 'Send OTP';
            document.getElementById('send-otp-btn').disabled = false;
            document.getElementById('auth-overlay').classList.add('active');
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('otp-form').style.display = 'none';
            document.getElementById('profile-form').style.display = 'none';
            document.getElementById('auth-divider').style.display = '';
            document.getElementById('auth-social-btns').style.display = '';
            document.getElementById('auth-footer').style.display = '';
        }

        function showSignupSection() {
            authMode = 'signup';
            document.getElementById('auth-modal-title').textContent = 'Sign up';
            document.getElementById('auth-mode-toggle').textContent = 'LOG IN';
            document.getElementById('otp-verify-btn').textContent = 'VERIFY';
            document.getElementById('send-otp-btn').textContent = 'VERIFY';
            document.getElementById('send-otp-btn').disabled = false;
            document.getElementById('auth-overlay').classList.add('active');
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('otp-form').style.display = 'none';
            document.getElementById('profile-form').style.display = 'none';
            document.getElementById('auth-divider').style.display = '';
            document.getElementById('auth-social-btns').style.display = '';
            document.getElementById('auth-footer').style.display = '';
        }

        function closeAuthModal() {
            document.getElementById('auth-overlay').classList.remove('active');
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('otp-form').style.display = 'none';
            document.getElementById('profile-form').style.display = 'none';
            document.getElementById('auth-divider').style.display = '';
            document.getElementById('auth-social-btns').style.display = '';
            document.getElementById('auth-footer').style.display = '';
            document.getElementById('auth-mode-toggle').style.display = '';
            document.getElementById('email-address').value = '';
            document.getElementById('otp-code').value = '';
            document.getElementById('profile-firstname').value = '';
            document.getElementById('profile-lastname').value = '';
            document.getElementById('profile-username').value = '';
            document.getElementById('profile-age').value = '';
            authMode = 'login';
            authUserId = null;
            isNewUser = false;
        }

        function hideLoginSection() { closeAuthModal(); }

        function showLoginForm() {
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('otp-form').style.display = 'none';
            document.getElementById('profile-form').style.display = 'none';
            document.getElementById('auth-divider').style.display = '';
            document.getElementById('auth-social-btns').style.display = '';
            document.getElementById('auth-footer').style.display = '';
            document.getElementById('otp-code').value = '';
        }

        function logout() {
            document.cookie = 'm_at=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            document.cookie = 'm_rt=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            document.cookie = 'm_did=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            isAuthenticated = false;
            navigateTo('home');
            checkAuth();
            showToast('Logged out successfully', 'success');
            debugLog('User logged out', 'info');
        }

        // API Helper
        async function apiCall(endpoint, method = 'GET', body = null) {
            try {
                const url = `${API_BASE}${endpoint}`;

                debugLog(`🔵 ${method} ${url}`, 'info');

                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include', // Important: include cookies in request
                };

                if (body) {
                    options.body = JSON.stringify(body);
                    debugLog(`📦 Request Body: ${JSON.stringify(body)}`, 'info');
                }

                const response = await fetch(url, options);
                debugLog(`📡 Response Status: ${response.status} ${response.statusText}`, response.ok ? 'info' : 'warn');

                const data = await response.json();
                debugLog(`📊 Response Data: ${JSON.stringify(data, null, 2)}`, response.ok ? 'info' : 'error');

                if (!response.ok) {
                    throw new Error(data.message || `API Error: ${response.status}`);
                }

                return data;
            } catch (error) {
                debugLog(`❌ Error: ${error.message}`, 'error');
                showToast(error.message, 'error');
                throw error;
            }
        }

        // Toast notifications
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 5px;">${type === 'success' ? '✅' : '❌'} ${type === 'success' ? 'Success' : 'Error'}</div>
                <div>${message}</div>
            `;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 4000);
        }

        // Loading state
        function showLoading(containerId) {
            document.getElementById(containerId).innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <div>Loading...</div>
                </div>
            `;
        }

        // Onboarding
        async function startOnboarding() {
            try {
                debugLog('🎯 Starting onboarding...', 'info');
                debugLog('Step 1: Navigating to onboarding page', 'info');
                navigateTo('onboarding');

                debugLog('Step 2: Showing loading state', 'info');
                showLoading('onboarding-content');

                debugLog('Step 3: Making API call', 'info');
                const data = await apiCall('/onboarding/questions');

                debugLog('✅ Onboarding questions received', 'info');
                debugLog('Step 4: Rendering questions', 'info');
                debugLog('Questions data:', 'info');
                debugLog(JSON.stringify(data, null, 2), 'info');
                appState.onboardingQuestions = data.data || data.questions || [];
                debugLog(`Number of questions: ${appState.onboardingQuestions.length}`, 'info');
                renderOnboardingQuestions();
            } catch (error) {
                debugLog(`❌ Failed to load onboarding: ${error.message}`, 'error');
                debugLog(`Error stack: ${error.stack}`, 'error');

                const container = document.getElementById('onboarding-content');
                if (container) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">😔</div>
                            <div>Failed to load onboarding questions</div>
                            <div style="color: #f44336; margin-top: 10px; font-family: monospace;">${error.message}</div>
                            <button type="button" class="btn-primary" onclick="startOnboarding(); return false;" style="margin-top: 20px;">Try Again</button>
                        </div>
                    `;
                }
            }
        }

        function renderOnboardingQuestions() {
            const container = document.getElementById('onboarding-content');

            if (!appState.onboardingQuestions || appState.onboardingQuestions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📝</div>
                        <div>No onboarding questions available</div>
                        <button class="btn-primary" onclick="startOnboarding()" style="margin-top: 20px;">Retry</button>
                    </div>
                `;
                return;
            }

            // Filter out target_language question
            const questions = appState.onboardingQuestions.filter(q => q.questionType !== 'target_language');
            appState.currentQuestionIndex = 0;
            appState.onboardingAnswers = {};

            let html = '<div class="onboarding-container">';

            // Progress bar
            html += `
                <div class="onboarding-progress">
                    <div class="onboarding-progress-fill" id="onboarding-progress" style="width: 0%"></div>
                </div>
            `;

            // Render each question
            questions.forEach((q, idx) => {
                debugLog(`Rendering question ${idx + 1}: ${q.questionType}`, 'info');

                const fieldName = q.questionType;
                const isActive = idx === 0 ? 'active' : '';

                // Determine grid layout
                const isSingleColumn = fieldName === 'cefr_level' || fieldName === 'proficiency_level';
                const gridClass = isSingleColumn ? 'options-grid single-column' : 'options-grid';

                html += `
                    <div class="onboarding-question ${isActive}" data-question-index="${idx}" data-field-name="${fieldName}">
                        <div class="mascot-section">
                            <div class="speech-bubble">
                                <h2>${q.question}</h2>
                            </div>
                        </div>

                        <div class="${gridClass}" id="options-${idx}">
                `;

                // Render options with icons
                if (q.suggestedAnswers && q.suggestedAnswers.length > 0) {
                    q.suggestedAnswers.forEach((option, optIdx) => {
                        const icon = getOptionIcon(fieldName, option);
                        const subtitle = getOptionSubtitle(fieldName, option);

                        html += `
                            <div class="option-card" onclick="selectOption(${idx}, '${fieldName}', '${option.replace(/'/g, "\\'")}')">
                                <div class="option-icon">${icon}</div>
                                <div class="option-text">
                                    <div class="option-title">${option}</div>
                                    ${subtitle ? `<div class="option-subtitle">${subtitle}</div>` : ''}
                                </div>
                            </div>
                        `;
                    });
                }

                html += `
                        </div>

                        <div class="onboarding-actions">
                            ${idx > 0 ? '<button class="btn-back" onclick="previousQuestion()">Back</button>' : ''}
                            <button class="btn-continue" id="continue-btn-${idx}" onclick="nextQuestion()" disabled>Continue</button>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;

            updateProgress();
        }

        function getOptionIcon(fieldName, option) {
            // SVG bar-chart icons for CEFR/proficiency
            const barIcon = (filled, total=5) => {
                const bars = Array.from({length: total}, (_, i) => {
                    const h = 6 + i * 4;
                    const lit = i < filled;
                    return `<rect x="${i*7}" y="${28-h}" width="5" height="${h}" rx="1.5" fill="${lit ? '#58a5f0' : '#374151'}"/>`;
                }).join('');
                return `<svg viewBox="0 0 34 30" width="28" height="28" xmlns="http://www.w3.org/2000/svg">${bars}</svg>`;
            };

            const em = (e) => `<span style="font-size:1.55em;line-height:1;">${e}</span>`;

            // Language flags
            const flags = {
                'English': '🇺🇸', 'Russian': '🇷🇺', 'Arabic': '🇸🇦', 'Spanish': '🇪🇸',
                'French': '🇫🇷', 'German': '🇩🇪', 'Chinese': '🇨🇳', 'Japanese': '🇯🇵',
                'Korean': '🇰🇷', 'Italian': '🇮🇹', 'Portuguese': '🇵🇹', 'Turkish': '🇹🇷',
                'Hindi': '🇮🇳', 'Uzbek': '🇺🇿',
            };

            // Purpose / learning goal emojis — Duolingo style
            const purposeIcons = {
                'Travel': em('✈️'), 'Business Work': em('💼'), 'Study Abroad': em('🎒'),
                'Personal Interest': em('🎉'), 'Family Friends': em('👨‍👩‍👧'), 'Immigration': em('🏠'),
                'Career Change': em('📈'), 'Exam Preparation': em('📝'), 'Cultural Understanding': em('🎭'),
                'Brain Training': em('🧠'), 'Just for fun': em('🎉'), 'Prepare for travel': em('✈️'),
                'Boost my career': em('💼'), 'Connect with people': em('👨‍👩‍👧'), 'Support my education': em('📚'),
                'Spend time productively': em('🧠'), 'Other': em('💬'),
            };

            // Interests emojis
            const interestIcons = {
                'Business': em('💼'), 'Business & Work': em('💼'),
                'Travel': em('✈️'), 'Travel & Tourism': em('✈️'),
                'Food': em('🍕'), 'Food & Cooking': em('🍕'),
                'Sports': em('⚽'), 'Sports & Fitness': em('⚽'),
                'Technology': em('💻'),
                'Health': em('💪'), 'Health & Wellness': em('💪'),
                'Education': em('📚'), 'Education & Learning': em('📚'),
                'Culture': em('🎭'), 'Culture & Arts': em('🎭'),
                'Daily': em('☀️'),
                'Entertainment': em('🎬'),
                'Shopping': em('🛍️'),
            };

            // Study time
            const studyTimeIcons = {
                '10-15 min': em('⏱️'), '15-30 min': em('⏰'), '30-60 min': em('🕐'), '1+ hour': em('🔥'),
            };

            // Referral source — brand SVGs matching Duolingo reference exactly
            const referralIcons = {
                'YouTube': `<svg viewBox="0 0 32 32" width="32" height="32"><rect width="32" height="32" rx="7" fill="#FF0000"/><polygon points="13,10 13,22 23,16" fill="white"/></svg>`,
                'TikTok': `<svg viewBox="0 0 32 32" width="32" height="32"><rect width="32" height="32" rx="7" fill="#010101"/><path d="M21 8h-3v10.5a2.5 2.5 0 11-2.5-2.5c.2 0 .4 0 .5.05V13a5.5 5.5 0 105.5 5.5V12a7.5 7.5 0 004.5 1.5v-3a4.5 4.5 0 01-4.5-4.5z" fill="white" transform="translate(-4,-2) scale(1.1)"/></svg>`,
                'Google Search': `<svg viewBox="0 0 32 32" width="32" height="32"><rect width="32" height="32" rx="7" fill="white"/><text x="3" y="22" font-size="18" font-weight="900" font-family="Arial,sans-serif"><tspan fill="#4285F4">G</tspan></text><path d="M22 16a6 6 0 10-1.76 4.24l-2.12-2.12A3 3 0 1119 16h-3v2h6v-2z" fill="#4285F4"/></svg>`,
                'Facebook/Instagram': `<svg viewBox="0 0 32 32" width="32" height="32"><rect width="15" height="32" rx="4" fill="#1877F2"/><rect x="17" width="15" height="32" rx="4" fill="url(#igGrad)"/><defs><linearGradient id="igGrad" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#F58529"/><stop offset="50%" stop-color="#DD2A7B"/><stop offset="100%" stop-color="#515BD4"/></linearGradient></defs><text x="2" y="21" font-size="16" font-weight="900" fill="white" font-family="Arial">f</text><rect x="20" y="9" width="7" height="7" rx="2" fill="none" stroke="white" stroke-width="1.5"/><rect x="22" y="11" width="3" height="3" rx="0.8" fill="white"/><circle cx="27" cy="9.5" r="1" fill="white"/></svg>`,
                'Social Media': `<svg viewBox="0 0 32 32" width="32" height="32"><rect width="32" height="32" rx="7" fill="#1877F2"/><text x="4" y="22" font-size="17" font-weight="900" fill="white" font-family="Arial">f</text><rect x="18" y="8" width="10" height="10" rx="3" fill="url(#igGrad2)"/><defs><linearGradient id="igGrad2" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#F58529"/><stop offset="50%" stop-color="#DD2A7B"/><stop offset="100%" stop-color="#515BD4"/></linearGradient></defs><rect x="20" y="10" width="6" height="6" rx="1.5" fill="none" stroke="white" stroke-width="1.2"/><circle cx="22.5" cy="12.5" r="1.5" fill="white" opacity="0.9"/></svg>`,
                'TV': `<svg viewBox="0 0 32 32" width="32" height="32"><rect x="2" y="6" width="28" height="18" rx="3" fill="#4b5563" stroke="#6b7280" stroke-width="1.5"/><rect x="4" y="8" width="24" height="14" rx="2" fill="#1f2937"/><rect x="11" y="25" width="10" height="3" rx="1.5" fill="#6b7280"/><rect x="15" y="24" width="2" height="2" fill="#6b7280"/></svg>`,
                'Tv': `<svg viewBox="0 0 32 32" width="32" height="32"><rect x="2" y="6" width="28" height="18" rx="3" fill="#4b5563" stroke="#6b7280" stroke-width="1.5"/><rect x="4" y="8" width="24" height="14" rx="2" fill="#1f2937"/><rect x="11" y="25" width="10" height="3" rx="1.5" fill="#6b7280"/><rect x="15" y="24" width="2" height="2" fill="#6b7280"/></svg>`,
                'Friends': `<svg viewBox="0 0 32 32" width="32" height="32"><circle cx="11" cy="9" r="5" fill="#fbbf24"/><path d="M2 26c0-5 4-8 9-8s9 3 9 8" fill="#fbbf24" opacity="0.85"/><circle cx="22" cy="10" r="4" fill="#f97316"/><path d="M15 26c0-4 3-6.5 7-6.5s7 2.5 7 6.5" fill="#f97316" opacity="0.85"/></svg>`,
                'Friends/family': `<svg viewBox="0 0 32 32" width="32" height="32"><circle cx="11" cy="9" r="5" fill="#fbbf24"/><path d="M2 26c0-5 4-8 9-8s9 3 9 8" fill="#fbbf24" opacity="0.85"/><circle cx="22" cy="10" r="4" fill="#f97316"/><path d="M15 26c0-4 3-6.5 7-6.5s7 2.5 7 6.5" fill="#f97316" opacity="0.85"/></svg>`,
                'Family': `<svg viewBox="0 0 32 32" width="32" height="32"><circle cx="11" cy="9" r="5" fill="#fbbf24"/><path d="M2 26c0-5 4-8 9-8s9 3 9 8" fill="#fbbf24" opacity="0.85"/><circle cx="22" cy="10" r="4" fill="#f97316"/><path d="M15 26c0-4 3-6.5 7-6.5s7 2.5 7 6.5" fill="#f97316" opacity="0.85"/></svg>`,
                'Internet': `<svg viewBox="0 0 32 32" width="32" height="32"><circle cx="16" cy="16" r="12" fill="none" stroke="#60a5fa" stroke-width="2"/><ellipse cx="16" cy="16" rx="6" ry="12" fill="none" stroke="#60a5fa" stroke-width="1.8"/><line x1="4" y1="16" x2="28" y2="16" stroke="#60a5fa" stroke-width="1.8"/><line x1="6" y1="10" x2="26" y2="10" stroke="#60a5fa" stroke-width="1.3"/><line x1="6" y1="22" x2="26" y2="22" stroke="#60a5fa" stroke-width="1.3"/></svg>`,
                'News/article/blog': `<svg viewBox="0 0 32 32" width="32" height="32"><rect x="3" y="4" width="26" height="24" rx="3" fill="#374151" stroke="#6b7280" stroke-width="1.5"/><rect x="7" y="9" width="18" height="3" rx="1.5" fill="#9ca3af"/><rect x="7" y="14" width="12" height="2" rx="1" fill="#6b7280"/><rect x="7" y="18" width="15" height="2" rx="1" fill="#6b7280"/><rect x="7" y="22" width="9" height="2" rx="1" fill="#6b7280"/></svg>`,
                'Other': `<svg viewBox="0 0 32 32" width="32" height="32"><circle cx="16" cy="16" r="13" fill="#7c3aed"/><circle cx="10" cy="16" r="2" fill="white"/><circle cx="16" cy="16" r="2" fill="white"/><circle cx="22" cy="16" r="2" fill="white"/></svg>`,
                'other': `<svg viewBox="0 0 32 32" width="32" height="32"><circle cx="16" cy="16" r="13" fill="#7c3aed"/><circle cx="10" cy="16" r="2" fill="white"/><circle cx="16" cy="16" r="2" fill="white"/><circle cx="22" cy="16" r="2" fill="white"/></svg>`,
            };

            // CEFR / proficiency bar icons
            const cefrBars = {
                'A1 - Beginner': barIcon(1), 'A1': barIcon(1),
                'A2 - Elementary': barIcon(2), 'A2': barIcon(2),
                'B1 - Intermediate': barIcon(3), 'B1': barIcon(3),
                'B2 - Upper Intermediate': barIcon(4), 'B2': barIcon(4),
                'C1 - Advanced': barIcon(5), 'C1': barIcon(5),
                'C2 - Proficient': barIcon(5), 'C2': barIcon(5),
                'Beginner': barIcon(1), 'Elementary': barIcon(2),
                'Intermediate': barIcon(3), 'Upper-Intermediate': barIcon(4), 'Advanced': barIcon(5),
            };

            if (fieldName === 'native_language' || fieldName === 'target_language') {
                return `<span style="font-size:1.6em;line-height:1;">${flags[option] || '🌐'}</span>`;
            }
            if (fieldName === 'cefr_level' || fieldName === 'proficiency_level') {
                return cefrBars[option] || barIcon(1);
            }
            if (fieldName === 'referral_source') return referralIcons[option] || referralIcons['Other'];
            if (fieldName === 'purpose' || fieldName === 'learning_goal') return purposeIcons[option] || em('✨');
            if (fieldName === 'interests') return interestIcons[option] || em('✨');
            if (fieldName === 'study_time') return studyTimeIcons[option] || em('⏱️');
            // fallback: check all maps
            return referralIcons[option] || purposeIcons[option] || interestIcons[option] || studyTimeIcons[option] || cefrBars[option] || em('✨');
        }

        function getOptionSubtitle(fieldName, option) {
            const subtitles = {
                'cefr_level': {
                    'A1': "I'm new",
                    'A2': 'I know some common words',
                    'B1': 'I can have basic conversations',
                    'B2': 'I can talk about various topics',
                    'C1': 'I can discuss most topics in detail',
                    'C2': 'I am highly proficient'
                },
                'proficiency_level': {
                    'Beginner': "I'm new to this language",
                    'Elementary': 'I know basic words and phrases',
                    'Intermediate': 'I can have simple conversations',
                    'Upper-Intermediate': 'I can discuss many topics',
                    'Advanced': 'I am highly proficient'
                },
                'learning_goal': {
                    'Travel': 'Prepare for travel',
                    'Career': 'Boost my career',
                    'Education': 'Support my education',
                    'Personal Interest': 'Just for fun',
                    'Family': 'Connect with people',
                    'Culture': 'Explore culture and arts'
                }
            };

            return subtitles[fieldName]?.[option] || '';
        }

        function selectOption(questionIndex, fieldName, value) {
            // Remove selection from all options in this question
            document.querySelectorAll(`#options-${questionIndex} .option-card`).forEach(card => {
                card.classList.remove('selected');
            });

            // Add selection to clicked option
            event.currentTarget.classList.add('selected');

            // Store answer
            appState.onboardingAnswers[fieldName] = value;

            // Enable continue button
            document.getElementById(`continue-btn-${questionIndex}`).disabled = false;

            debugLog(`Selected: ${fieldName} = ${value}`, 'info');
        }

        function nextQuestion() {
            const questions = appState.onboardingQuestions.filter(q => q.questionType !== 'target_language');

            if (appState.currentQuestionIndex < questions.length - 1) {
                // Hide current question
                document.querySelector('.onboarding-question.active').classList.remove('active');

                // Show next question
                appState.currentQuestionIndex++;
                document.querySelector(`[data-question-index="${appState.currentQuestionIndex}"]`).classList.add('active');

                updateProgress();
            } else {
                // Last question - submit
                handleOnboardingSubmit();
            }
        }

        function previousQuestion() {
            if (appState.currentQuestionIndex > 0) {
                // Hide current question
                document.querySelector('.onboarding-question.active').classList.remove('active');

                // Show previous question
                appState.currentQuestionIndex--;
                document.querySelector(`[data-question-index="${appState.currentQuestionIndex}"]`).classList.add('active');

                updateProgress();
            }
        }

        function updateProgress() {
            const questions = appState.onboardingQuestions.filter(q => q.questionType !== 'target_language');
            const progress = ((appState.currentQuestionIndex + 1) / questions.length) * 100;
            document.getElementById('onboarding-progress').style.width = `${progress}%`;
        }

        async function handleOnboardingSubmit(e) {
            if (e) e.preventDefault();
            debugLog('📋 Submitting onboarding answers...', 'info');

            // Use stored answers from appState
            const rawAnswers = appState.onboardingAnswers;

            debugLog('Collected answers:', 'info');
            debugLog(JSON.stringify(rawAnswers, null, 2), 'info');

            // Language name to code mapping
            const languageMap = {
                'English': 'en',
                'Russian': 'ru',
                'Arabic': 'ar',
                'Spanish': 'es',
                'French': 'fr',
                'German': 'de',
                'Chinese': 'zh',
                'Japanese': 'ja',
                'Korean': 'ko',
                'Italian': 'it',
                'Portuguese': 'pt',
                'Turkish': 'tr',
                'Hindi': 'hi',
                'Uzbek': 'uz'
            };

            // Extract level from "A1 - Beginner" -> "A1"
            const levelValue = rawAnswers['cefr_level'] || rawAnswers['level'];
            const level = levelValue ? levelValue.split(' ')[0] : 'A1'; // Extract "A1" from "A1 - Beginner"

            // Convert language names to codes
            const nativeLang = rawAnswers['native_language'] || rawAnswers['nativeLanguage'];
            const nativeLanguage = languageMap[nativeLang] || nativeLang.toLowerCase().substring(0, 2);

            // Always default to English as target language
            const targetLanguage = 'en';

            debugLog('Target language defaulted to English (en)', 'info');

            // Convert answers to array format
            const onboardingAnswers = [];
            appState.onboardingQuestions.forEach(q => {
                const answer = rawAnswers[q.questionType];
                if (answer) {
                    onboardingAnswers.push({
                        question: q.question,
                        answer: answer
                    });
                }
            });

            // Format request body according to backend expectations
            const requestBody = {
                level: level,
                targetLanguage: targetLanguage,
                nativeLanguage: nativeLanguage,
                onboardingAnswers: onboardingAnswers
            };

            debugLog('Formatted request body:', 'info');
            debugLog(JSON.stringify(requestBody, null, 2), 'info');

            showLoading('onboarding-content');

            try {
                const result = await apiCall('/curriculum/create', 'POST', requestBody);
                debugLog('✅ Curriculum created successfully!', 'info');
                debugLog(result, 'info');
                showToast('Curriculum created successfully! 🎉');
                setTimeout(() => {
                    loadCurriculum();
                }, 1000);
            } catch (error) {
                debugLog(`❌ Failed to create curriculum: ${error.message}`, 'error');
                document.getElementById('onboarding-content').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">❌</div>
                        <div>Failed to create curriculum</div>
                        <div style="color: #f44336; margin-top: 10px; font-family: monospace; font-size: 12px;">${error.message}</div>
                        <button class="btn-primary" onclick="startOnboarding()" style="margin-top: 20px;">Try Again</button>
                    </div>
                `;
            }
        }

        // Curriculum
        async function loadCurriculum() {
            navigateTo('curriculum');
            showLoading('curriculum-info');

            try {
                const response = await apiCall('/curriculum-full');
                debugLog('Full curriculum response:', 'info');

                // Don't stringify - it breaks the Buffer objects
                debugLog('Response structure:', 'info');
                debugLog(`  success: ${response.success}`, 'info');
                debugLog(`  has data: ${!!response.data}`, 'info');

                // Handle different response structures
                const curriculum = response.data?.curriculum || response.curriculum || response.data;
                const units = response.data?.units || curriculum.units || [];
                const progress = response.data?.progress || curriculum.progress || {};

                if (!curriculum) {
                    throw new Error('No curriculum data in response');
                }

                // Store both units data and curriculum
                curriculum.units = units;

                // Store progress data
                appState.progress = progress;
                appState.completedLessons = progress.completedLessons || [];
                appState.completedSections = progress.completedSections || [];
                appState.sectionStats = progress.sectionStats || [];

                debugLog(`Progress: ${appState.completedLessons.length} lessons completed, ${appState.completedSections.length} sections completed`, 'info');

                // Pre-populate lessonSections from lesson.sectionIds returned by API
                units.forEach(unit => {
                    (unit.lessons || []).forEach(lesson => {
                        const lessonId = lesson._id?.toString();
                        if (lessonId && lesson.sectionIds) {
                            appState.lessonSections[lessonId] = {
                                flashcard: lesson.sectionIds.flashcard,
                                story: lesson.sectionIds.story,
                                test: lesson.sectionIds.test,
                            };
                        }
                    });
                });

                // Also store units in appState for direct access
                appState.unitsData = units;

                debugLog(`Found ${curriculum.units.length} units with lessons`, 'info');

                appState.curriculum = curriculum;
                renderCurriculum();
            } catch (error) {
                debugLog(`Error loading curriculum: ${error.message}`, 'error');
                document.getElementById('curriculum-info').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📚</div>
                        <div>No curriculum found. Let's create one!</div>
                        <button class="btn-primary" onclick="startOnboarding()" style="margin-top: 20px;">Start Onboarding</button>
                    </div>
                `;
            }
        }

        // ── Path rendering helpers ─────────────────────────────────────────────

        const STAR_SVG = `<svg class="star-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
        </svg>`;

        const LOCK_SVG = `<svg class="star-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1s3.1 1.39 3.1 3.1v2z"/>
        </svg>`;

        const CHECK_SVG = `<svg class="star-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
        </svg>`;

        const FASTFORWARD_SVG = `<svg class="star-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M4 18l8.5-6L4 6v12zm9-12v12l8.5-6L13 6z"/>
        </svg>`;

        const GUIDEBOOK_ICON_SVG = `<svg width="18" height="18" viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg">
            <path d="M4 6h16v2H4zm0 5h16v2H4zm0 5h16v2H4z"/>
        </svg>`;

        const TROPHY_SVG = `<svg viewBox="0 0 64 64" width="48" height="48" xmlns="http://www.w3.org/2000/svg">
            <!-- Cup body -->
            <path d="M20 8 h24 v20 c0 10-6 18-12 20 c-6-2-12-10-12-20 Z" fill="#FFD700" stroke="#e6a800" stroke-width="1.5"/>
            <!-- Shine on cup -->
            <path d="M24 12 q2-2 5-1" stroke="rgba(255,255,255,0.7)" stroke-width="2.5" stroke-linecap="round" fill="none"/>
            <!-- Left handle -->
            <path d="M20 14 c-8 0-10 12-4 14 l4-2" fill="none" stroke="#FFD700" stroke-width="3.5" stroke-linecap="round"/>
            <!-- Right handle -->
            <path d="M44 14 c8 0 10 12 4 14 l-4-2" fill="none" stroke="#FFD700" stroke-width="3.5" stroke-linecap="round"/>
            <!-- Stem -->
            <rect x="28" y="48" width="8" height="6" rx="2" fill="#FFD700" stroke="#e6a800" stroke-width="1.5"/>
            <!-- Base -->
            <rect x="20" y="54" width="24" height="5" rx="3" fill="#FFD700" stroke="#e6a800" stroke-width="1.5"/>
            <!-- Stars on cup -->
            <circle cx="32" cy="24" r="3" fill="#fff" opacity="0.5"/>
            <circle cx="26" cy="20" r="1.8" fill="#fff" opacity="0.35"/>
            <circle cx="38" cy="20" r="1.8" fill="#fff" opacity="0.35"/>
        </svg>`;

        const TOPIC_PALETTE = ['health','food','entertainment','daily'];

        const TOPIC_COLORS = {
            health:        { a: '#58CC03', b: '#45a302', s: '#2d6b01' },
            food:          { a: '#FF9601', b: '#cc7800', s: '#8f5400' },
            entertainment: { a: '#FF4B4B', b: '#cc3333', s: '#8f1f1f' },
            daily:         { a: '#9333ea', b: '#6b21a8', s: '#4c1476' },
        };

        function getTopicClass(unit, unitIdx) {
            // Cycle through 4 colors: green, orange, red, purple
            return `topic-${TOPIC_PALETTE[unitIdx % TOPIC_PALETTE.length]}`;
        }

        function getTopicColors(unitIdx) {
            return TOPIC_COLORS[TOPIC_PALETTE[unitIdx % TOPIC_PALETTE.length]];
        }

        function makeLessonNode(lesson, lessonIdx, unitIdx, isCompleted, isActive, isLocked, offsetClass, showBear, sectionsCompleted, isJumpHere) {
            const unitDone = isUnitCompleted(unitIdx);
            const statusClass = isCompleted ? (unitDone ? 'completed unit-done' : 'completed') : (isActive || isJumpHere) ? 'active' : 'locked';
            const onclick = (isLocked && !isJumpHere) ? '' : `onclick="openLesson(${unitIdx}, ${lessonIdx}, this)"`;
            const tc = getTopicColors(unitIdx);
            const icon = isJumpHere ? FASTFORWARD_SVG : isLocked ? LOCK_SVG : isCompleted ? CHECK_SVG : STAR_SVG;

            // Build 3-segment progress arc
            const C = 2 * Math.PI * 46;
            const GAP = 8;
            const SEG = (C - GAP * 3) / 3;
            const TOTAL_SEG = SEG + GAP;

            const segsLit = isCompleted ? 3 : (sectionsCompleted || 0);
            const segColor = (isCompleted && unitDone) ? '#fbbf24' : isCompleted ? '#4ade80' : (isActive || isJumpHere) ? tc.a : 'var(--lc-a, #9333ea)';

            function segArc(idx) {
                const isLit = idx < segsLit;
                const dashOffset = C - (idx * TOTAL_SEG);
                return `<circle class="ring-seg" cx="52" cy="52" r="46"
                    fill="none" stroke-width="7"
                    stroke="${isLit ? segColor : 'transparent'}"
                    stroke-dasharray="${SEG} ${C - SEG}"
                    stroke-dashoffset="${dashOffset}"
                    stroke-linecap="round"/>`;
            }

            const ringArc = `
                <svg class="lesson-ring-svg" viewBox="0 0 104 104">
                    <circle class="ring-bg" cx="52" cy="52" r="46" />
                    ${segArc(0)}${segArc(1)}${segArc(2)}
                </svg>`;

            const particles = (isCompleted && unitDone) ? `<div class="trophy-particles"><div class="trophy-particle"></div><div class="trophy-particle"></div><div class="trophy-particle"></div><div class="trophy-particle"></div><div class="trophy-particle"></div><div class="trophy-particle"></div><div class="trophy-particle"></div><div class="trophy-particle"></div></div>` : '';

            return `
                <div class="lesson-node ${offsetClass}" ${onclick} style="${(isLocked && !isJumpHere) ? '' : 'cursor:pointer;'}">
                    ${isActive && !isJumpHere ? `<div class="lesson-label" style="--ll-color:${tc.a};--ll-border:${tc.a}55;">START</div><div class="lesson-label-spacer"></div>` : ''}
                    ${isJumpHere ? `<div class="lesson-label lesson-label-jump" style="--ll-color:${tc.a};--ll-border:${tc.a}55;">JUMP HERE?</div><div class="lesson-label-spacer"></div>` : ''}
                    ${isJumpHere ? `
                    <div class="lesson-jump-circle" style="background:linear-gradient(160deg,${tc.a},${tc.b});box-shadow:0 7px 0 ${tc.s};">
                        ${FASTFORWARD_SVG}
                    </div>` : `
                    <div class="lesson-ring ${statusClass}">
                        ${ringArc}
                        <div class="lesson-circle" ${isActive ? `style="background:linear-gradient(155deg,${tc.a},${tc.b});box-shadow:0 6px 0 ${tc.s};"` : ''}>
                            ${icon}
                        </div>
                        ${particles}
                    </div>`}
                    <div class="lesson-type">${lesson.title || `Lesson ${lessonIdx + 1}`}</div>
                </div>`;
        }

        function makeConnector(isCompleted) {
            return `<div class="path-connector ${isCompleted ? 'completed' : ''}"></div>`;
        }

        // ───────────────────────────────────────────────────────────────────────

        function renderCurriculum() {
            const curriculum = appState.curriculum;

            debugLog('Rendering full curriculum path...', 'info');

            // Clear info header
            document.getElementById('curriculum-info').innerHTML = '';

            const unitsGrid = document.getElementById('units-grid');
            if (!curriculum.units || curriculum.units.length === 0) {
                unitsGrid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📖</div>
                        <div>No units available yet</div>
                        <button class="btn-primary" onclick="startOnboarding()" style="margin-top: 20px;">Create Curriculum</button>
                    </div>
                `;
                return;
            }

            // Build one continuous path across ALL units
            let html = '<div class="full-path">';

            curriculum.units.forEach((unit, unitIdx) => {
                debugLog(`Rendering unit ${unitIdx + 1}: ${unit.title}`, 'info');

                // Check if this whole unit is locked (previous unit not done)
                const unitIsLocked = false; // all units unlocked

                const topicClass = getTopicClass(unit, unitIdx);

                // Unit section header banner
                html += `
                    <div class="unit-section" id="unit-section-${unitIdx}">
                        <div class="unit-header ${topicClass} ${unitIsLocked ? 'unit-header-locked' : ''}">
                            <div class="unit-header-left">
                                <h2>SECTION ${unitIdx + 1}, UNIT ${unitIdx + 1}</h2>
                                <h1>${unit.title || 'Untitled Unit'}</h1>
                            </div>
                            <button class="btn-guidebook" onclick="openGuidebook(${unitIdx})">
                                <div class="guidebook-icon">${GUIDEBOOK_ICON_SVG}</div>
                                GUIDEBOOK
                            </button>
                        </div>

                        <div class="lesson-path">
                `;

                const lessons = unit.lessons || [];

                if (lessons.length === 0) {
                    html += `<div style="color: var(--text-secondary); text-align:center; padding: 20px;">No lessons yet</div>`;
                } else {
                    const snakeOffsets = ['path-offset-center', 'path-offset-right', 'path-offset-center', 'path-offset-left'];

                    lessons.forEach((lesson, lessonIdx) => {
                        const lessonId = extractId(lesson._id);
                        const isCompleted = appState.completedLessons?.some(id => extractId(id) === lessonId) || false;
                        const prevCompleted = lessonIdx === 0 ? true : appState.completedLessons?.some(id => {
                            return extractId(id) === extractId(lessons[lessonIdx - 1]._id);
                        });
                        const isActive = !unitIsLocked && !isCompleted && prevCompleted;
                        const isLocked = unitIsLocked || (!isCompleted && !prevCompleted);
                        const offsetClass = snakeOffsets[lessonIdx % 4];
                        const showBear = lessonIdx === 2;

                        // Count how many sections of this lesson are completed
                        const lessonSecs = appState.lessonSections[lessonId] || {};
                        const sectionsCompleted = [lessonSecs.flashcard, lessonSecs.story, lessonSecs.test]
                            .filter(secId => secId && appState.completedSections?.some(cid => extractId(cid) === extractId(secId)))
                            .length;

                        const unitHasNoProgress = !lessons.some(l => appState.completedLessons?.some(id => extractId(id) === extractId(l._id)));
                        const isJumpHere = lessonIdx === 0 && unitHasNoProgress && unitIdx > 0;
                        if (lessonIdx > 0) html += makeConnector(isCompleted);
                        html += makeLessonNode(lesson, lessonIdx, unitIdx, isCompleted, isActive, isLocked, offsetClass, showBear, sectionsCompleted, isJumpHere);
                    });

                }

                html += `</div></div>`; // close lesson-path + unit-section

                // Gap between units
                html += `<div style="height: 20px;"></div>`;
            });

            html += '</div>';
            unitsGrid.innerHTML = html;
            debugLog('✅ Full curriculum path rendered!', 'info');

            // ── Sticky curriculum unit headers: observe each sentinel ──
            if (window._curriculumObservers) {
                window._curriculumObservers.forEach(o => o.disconnect());
            }
            window._curriculumObservers = [];
            document.querySelectorAll('#units-grid .unit-section').forEach((section) => {
                const header = section.querySelector('.unit-header');
                if (!header) return;
                // Sentinel sits just above the section
                const sentinel = document.createElement('div');
                sentinel.style.cssText = 'height:1px;margin-top:-1px;pointer-events:none;';
                section.insertBefore(sentinel, section.firstChild);
                const obs = new IntersectionObserver(([entry]) => {
                    header.classList.toggle('is-stuck', !entry.isIntersecting);
                }, { threshold: 0, rootMargin: '-59px 0px 0px 0px' });
                obs.observe(sentinel);
                window._curriculumObservers.push(obs);
            });
        }

        function isUnitCompleted(unitIdx) {
            const unit = appState.curriculum?.units?.[unitIdx];
            if (!unit || !unit.lessons) return false;
            return unit.lessons.every(lesson => {
                const lessonId = extractId(lesson._id);
                return appState.completedLessons?.some(id => extractId(id) === lessonId);
            });
        }

        function openLesson(unitIdx, lessonIdx, triggerEl) {
            debugLog(`Opening lesson: unit ${unitIdx}, lesson ${lessonIdx}`, 'info');

            const unit   = appState.curriculum?.units?.[unitIdx];
            const lesson = unit?.lessons?.[lessonIdx];
            if (!lesson) return;

            const totalLessons = unit.lessons?.length || 1;
            const title = lesson.title || `Lesson ${lessonIdx + 1}`;

            // Populate popup
            document.getElementById('lesson-popup-title').textContent = title;
            document.getElementById('lesson-popup-sub').textContent   = `Lesson ${lessonIdx + 1} of ${totalLessons}`;

            // Position popup below the tapped ring
            const popup = document.getElementById('lesson-popup');
            const el = triggerEl || null;
            if (el) {
                // Use the ring element inside the node for accurate positioning
                const ringEl = el.querySelector('.lesson-ring') || el;
                const rect = ringEl.getBoundingClientRect();
                const scrollY = window.scrollY || document.documentElement.scrollTop;
                const scrollX = window.scrollX || document.documentElement.scrollLeft;
                const popupW = Math.min(300, window.innerWidth - 32);
                // Center popup horizontally on the ring, place it below (absolute coords)
                let left = rect.left + scrollX + rect.width / 2 - popupW / 2;
                left = Math.max(16, Math.min(left, window.innerWidth - popupW - 16));
                const top = rect.bottom + scrollY + 14; // 14px gap below ring
                popup.style.left = left + 'px';
                popup.style.top  = top + 'px';
                // Move arrow to point at the ring center
                const arrowLeft = rect.left + scrollX + rect.width / 2 - left;
                popup.style.setProperty('--arrow-left', arrowLeft + 'px');
            } else {
                // Fallback: center bottom
                popup.style.left   = '50%';
                popup.style.top    = '';
                popup.style.bottom = '90px';
                popup.style.transform = 'translateX(-50%)';
            }

            // Store callback
            window._lessonPopupStart = () => {
                closeLessonPopup();
                appState.currentUnitIndex = unitIdx;
                loadLessonByIndex(unitIdx, lessonIdx);
            };

            // Apply unit color to popup
            const tc = getTopicColors(unitIdx);
            popup.style.setProperty('--popup-color', tc.b);
            popup.style.setProperty('--popup-shadow', tc.s);

            // Hide START label while popup is open
            document.body.classList.add('lesson-popup-open');

            // Show
            document.getElementById('lesson-popup-backdrop').classList.add('visible');
            popup.classList.add('visible');

            // Auto-scroll so the full popup is visible
            requestAnimationFrame(() => {
                popup.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            });

        }

        function closeLessonPopup() {
            document.getElementById('lesson-popup-backdrop').classList.remove('visible');
            document.getElementById('lesson-popup').classList.remove('visible');
            // Restore START label
            document.body.classList.remove('lesson-popup-open');
        }

        // Load unit by index from cached data
        function loadUnitByIndex(unitIndex) {
            debugLog(`📖 Loading unit at index ${unitIndex}`, 'info');

            const unit = appState.curriculum?.units?.[unitIndex];

            if (!unit) {
                debugLog(`❌ Unit not found at index ${unitIndex}`, 'error');
                return;
            }

            navigateTo('unit');
            appState.currentUnitIndex = unitIndex;

            debugLog(`Unit loaded: ${unit.title} with ${unit.lessons?.length || 0} lessons`, 'info');
            renderUnit(unit);
        }

        // Unit Details (legacy - for API-based loading)
        async function loadUnit(unitId) {
            debugLog(`📖 Loading unit: ${unitId}`, 'info');
            navigateTo('unit');
            showLoading('unit-description');
            appState.currentUnit = unitId;

            try {
                const response = await apiCall(`/unit/${unitId}`);
                debugLog('Unit response:', 'info');
                debugLog(JSON.stringify(response).substring(0, 500), 'info');

                // Handle different response structures
                const unit = response.data?.unit || response.unit || response.data;

                if (!unit) {
                    throw new Error('No unit data in response');
                }

                debugLog(`Unit loaded: ${unit.title}`, 'info');
                renderUnit(unit);
            } catch (error) {
                debugLog(`❌ Failed to load unit: ${error.message}`, 'error');
                document.getElementById('unit-description').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">😔</div>
                        <div>Failed to load unit</div>
                        <div style="color: #f44336; margin-top: 10px; font-family: monospace; font-size: 12px;">${error.message}</div>
                        <button class="btn-secondary" onclick="navigateTo('curriculum')" style="margin-top: 20px;">← Back to Curriculum</button>
                    </div>
                `;
            }
        }

        function renderUnit(unit) {
            debugLog(`Rendering unit: ${unit.title}`, 'info');
            const unitIdx = appState.currentUnitIndex ?? 0;
            const topicClass = getTopicClass(unit, unitIdx);

            document.getElementById('unit-description').innerHTML = `
                <div class="unit-header ${topicClass}">
                    <div class="unit-header-left">
                        <h2>SECTION ${unitIdx + 1}, UNIT ${unitIdx + 1}</h2>
                        <h1>${unit.title || 'Untitled Unit'}</h1>
                    </div>
                    <button class="btn-guidebook" onclick="openGuidebook(${unitIdx})">
                        <div class="guidebook-icon">${GUIDEBOOK_ICON_SVG}</div>
                        GUIDEBOOK
                    </button>
                </div>
            `;

            const container = document.getElementById('sections-container');
            if (!unit.lessons || unit.lessons.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">📝</div><div>No lessons available</div></div>';
                return;
            }

            const snakeOffsets = ['path-offset-center', 'path-offset-right', 'path-offset-center', 'path-offset-left'];
            let html = '<div class="full-path"><div class="lesson-path">';

            unit.lessons.forEach((lesson, lessonIdx) => {
                const lessonId = extractId(lesson._id);
                const isCompleted = appState.completedLessons?.some(id => extractId(id) === lessonId) || false;
                const prevCompleted = lessonIdx === 0 ? true : appState.completedLessons?.some(id => {
                    return extractId(id) === extractId(unit.lessons[lessonIdx - 1]._id);
                });
                const isActive = !isCompleted && prevCompleted;
                const isLocked = !isCompleted && !prevCompleted;
                const offsetClass = snakeOffsets[lessonIdx % 4];
                const showBear = lessonIdx === 2;

                // Count completed sections for this lesson
                const lessonSecs = appState.lessonSections[lessonId] || {};
                const sectionsCompleted = [lessonSecs.flashcard, lessonSecs.story, lessonSecs.test]
                    .filter(secId => secId && appState.completedSections?.some(cid => extractId(cid) === extractId(secId)))
                    .length;

                if (lessonIdx > 0) html += makeConnector(isCompleted);
                // Use makeLessonNode but override onclick for unit page
                const nodeHtml = makeLessonNode(lesson, lessonIdx, unitIdx, isCompleted, isActive, isLocked, offsetClass, showBear, sectionsCompleted);
                html += nodeHtml; // keeps onclick="openLesson(...)" so popup shows
            });

            html += '</div></div>';
            container.innerHTML = html;
            container.style.paddingTop = '40px';
            debugLog('✅ Unit rendered', 'info');

            // ── Sticky header: observe sentinel to toggle .is-stuck ──
            const sticky   = document.getElementById('unit-description-sticky');
            const sentinel = document.getElementById('unit-header-sentinel');
            const spacer   = document.getElementById('unit-header-spacer');
            if (sticky && sentinel) {
                // Disconnect any previous observer
                if (window._unitHeaderObserver) window._unitHeaderObserver.disconnect();
                window._unitHeaderObserver = new IntersectionObserver(([entry]) => {
                    const stuck = !entry.isIntersecting;
                    sticky.classList.toggle('is-stuck', stuck);
                    if (spacer) spacer.classList.toggle('active', stuck);
                }, { threshold: 0, rootMargin: '-59px 0px 0px 0px' });
                window._unitHeaderObserver.observe(sentinel);
            }
        }

        async function backToUnit() {
            // Reload curriculum with fresh progress data and return to the scrollable path
            await loadCurriculum();
        }

        // ── Guidebook ──────────────────────────────────────────────────────────

        function openGuidebook(unitIdx) {
            const unit = appState.curriculum?.units?.[unitIdx];
            if (!unit) return;

            document.getElementById('guidebook-unit-label').textContent = `UNIT ${unitIdx + 1}`;
            document.getElementById('guidebook-title').textContent = unit.title || 'Guidebook';
            document.getElementById('guidebook-subtitle').textContent = unit.description || 'What you\'ll learn in this unit';

            // Build key phrases from lesson titles
            const lessons = unit.lessons || [];
            const phraseChips = lessons.map(l => {
                const title = l.title || '';
                return title ? `<span class="guidebook-phrase-chip">${title}</span>` : '';
            }).filter(Boolean).join('');

            document.getElementById('guidebook-body').innerHTML = `
                ${phraseChips ? `
                <div class="guidebook-key-phrases">
                    <div class="guidebook-key-phrases-label">Key Phrases</div>
                    <div class="guidebook-phrase-chips">${phraseChips}</div>
                </div>
                <div class="guidebook-divider"></div>` : ''}
                <div class="guidebook-sections-label">What's inside</div>
                <div class="guidebook-section-cards">
                    <div class="guidebook-sec-card flashcard-card">
                        <div class="guidebook-sec-icon">
                            <svg width="22" height="22" viewBox="0 0 24 24" fill="white"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.17L4 17.17V4h16v12z"/></svg>
                        </div>
                        <div class="guidebook-sec-text">
                            <div class="guidebook-sec-title">Flashcards</div>
                            <div class="guidebook-sec-desc">Learn new vocabulary words with images and pronunciation</div>
                        </div>
                    </div>
                    <div class="guidebook-sec-card story-card">
                        <div class="guidebook-sec-icon">
                            <svg width="22" height="22" viewBox="0 0 24 24" fill="white"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4zm12 16H6v-2h12v2zm0-4H6v-2h12v2zm0-4h-5V4h5v8z"/></svg>
                        </div>
                        <div class="guidebook-sec-text">
                            <div class="guidebook-sec-title">Story</div>
                            <div class="guidebook-sec-desc">Read a short story using the vocabulary words in real context</div>
                        </div>
                    </div>
                    <div class="guidebook-sec-card test-card">
                        <div class="guidebook-sec-icon">
                            <svg width="22" height="22" viewBox="0 0 24 24" fill="white"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>
                        </div>
                        <div class="guidebook-sec-text">
                            <div class="guidebook-sec-title">Test</div>
                            <div class="guidebook-sec-desc">Answer questions to test your knowledge of the unit</div>
                        </div>
                    </div>
                </div>`;

            document.getElementById('guidebook-overlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeGuidebook(e) {
            if (e && e.target !== document.getElementById('guidebook-overlay')) return;
            document.getElementById('guidebook-overlay').classList.remove('active');
            document.body.style.overflow = '';
        }

        function playWordAudio(url, e) {
            e?.stopPropagation();
            try {
                const audio = new Audio(url);
                audio.play();
            } catch(err) {
                debugLog(`Audio play failed: ${err.message}`, 'warn');
            }
        }

        // ───────────────────────────────────────────────────────────────────────

        // Load lesson by index - need to fetch from API to get real lesson with sections
        async function loadLessonByIndex(unitIndex, lessonIndex) {
            debugLog(`📝 Loading lesson: unit ${unitIndex}, lesson ${lessonIndex}`, 'info');

            const unit = appState.curriculum?.units?.[unitIndex];
            const lesson = unit?.lessons?.[lessonIndex];

            if (!lesson) {
                debugLog(`❌ Lesson not found`, 'error');
                return;
            }

            // Try to extract lesson ID
            let lessonId = extractId(lesson._id);

            if (!lessonId) {
                debugLog(`⚠️ No lesson ID available, trying alternative approach`, 'warn');
                // Alternative: Fetch unit lessons from API to get proper IDs
                try {
                    const unitId = extractId(unit._id);
                    if (unitId) {
                        const response = await apiCall(`/unit/${unitId}`);
                        const apiUnit = response.data?.unit || response.unit || response.data;
                        const apiLesson = apiUnit?.lessons?.[lessonIndex];
                        if (apiLesson) {
                            lessonId = extractId(apiLesson._id);
                            debugLog(`Got lesson ID from API: ${lessonId}`, 'info');
                        }
                    }
                } catch (error) {
                    debugLog(`Failed to get lesson from API: ${error.message}`, 'error');
                }
            }

            if (!lessonId) {
                showToast('Cannot load lesson - ID not available', 'error');
                return;
            }

            appState.currentLessonIndex = lessonIndex;
            loadLesson(lessonId, lesson.title);
        }

        // Lesson
        async function loadLesson(lessonId, lessonTitle, lessonData = null) {
            navigateTo('lesson');
            appState.currentLesson = lessonId;
            document.getElementById('lesson-title').textContent = lessonTitle;
            showLoading('lesson-content');

            try {
                // Check flashcard completion first
                const fcResponse = await apiCall(`/lesson/${lessonId}/flashcard`);
                const fcCompleted = fcResponse?.data?.isCompleted || false;

                // Store section IDs for progress ring
                const fcSectionId = fcResponse?.data?.section?._id;
                if (fcSectionId) {
                    if (!appState.lessonSections[lessonId]) appState.lessonSections[lessonId] = {};
                    appState.lessonSections[lessonId].flashcard = fcSectionId;
                }

                if (fcCompleted) {
                    // Flashcard done — check story
                    const storyResponse = await apiCall(`/lesson/${lessonId}/story`);
                    const storyCompleted = storyResponse?.data?.isCompleted || false;

                    const storySectionId = storyResponse?.data?.section?._id;
                    if (storySectionId) {
                        if (!appState.lessonSections[lessonId]) appState.lessonSections[lessonId] = {};
                        appState.lessonSections[lessonId].story = storySectionId;
                    }

                    if (storyCompleted) {
                        // Story done — go straight to test
                        await loadTest(lessonId);
                    } else {
                        // Resume at story
                        renderStory(storyResponse, lessonId);
                    }
                } else {
                    // Start from flashcard
                    renderFlashcard(fcResponse, lessonId);
                }
            } catch (error) {
                document.getElementById('lesson-content').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">😔</div>
                        <div>Failed to load lesson</div>
                    </div>
                `;
            }
        }

        async function loadFlashcard(lessonId) {
            debugLog(`Loading flashcard for lesson ${lessonId}`, 'info');
            const response = await apiCall(`/lesson/${lessonId}/flashcard`);
            debugLog(`Flashcard response received`, 'info');
            renderFlashcard(response, lessonId);
        }

        function renderFlashcard(response, lessonId) {
            debugLog(`Rendering flashcard...`, 'info');

            // Extract words from API response structure
            const data = response.data || response;
            const section = data.section;
            const isCompleted = data.isCompleted || false;
            const wordRefs = section?.wordRefs || [];

            // Store section ID for progress ring tracking
            if (section?._id && lessonId) {
                if (!appState.lessonSections[lessonId]) appState.lessonSections[lessonId] = {};
                appState.lessonSections[lessonId].flashcard = section._id;
            }

            debugLog(`Found ${wordRefs.length} word references`, 'info');
            debugLog(`Flashcard already completed: ${isCompleted}`, 'info');

            // If already completed, show completion message
            if (isCompleted) {
                const words = wordRefs.map(ref => {
                    const wordMedia = ref.wordMediaId;
                    return {
                        word: wordMedia.word,
                        translation: wordMedia.translations?.ru || wordMedia.translations?.uz || Object.values(wordMedia.translations || {})[0],
                        imageUrl: wordMedia.imageUrl,
                        audioUrl: wordMedia.wordAudioUrl
                    };
                });

                renderCompletedFlashcard(words, lessonId);
                return;
            }

            // Transform wordRefs to words array with proper structure
            const words = wordRefs.map(ref => {
                const wordMedia = ref.wordMediaId;
                return {
                    word: wordMedia.word,
                    translation: wordMedia.translations?.ru || wordMedia.translations?.uz || Object.values(wordMedia.translations || {})[0],
                    imageUrl: wordMedia.imageUrl,
                    audioUrl: wordMedia.wordAudioUrl
                };
            });

            if (words.length === 0) {
                document.getElementById('lesson-content').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🎴</div>
                        <div>No flashcards available</div>
                    </div>
                `;
                return;
            }

            debugLog(`Rendering ${words.length} flashcards`, 'info');

            let currentCard = 0;
            const flashcardCompleted = isCompleted; // Store completion status

            function renderCard() {
                const word = words[currentCard];
                const container = document.getElementById('lesson-content');
                const progress = Math.round(((currentCard + 1) / words.length) * 100);

                // Pick 1 random distractor → 2 choices total
                const others = words.filter((_, i) => i !== currentCard);
                const shuffledOthers = others.sort(() => Math.random() - 0.5);
                const distractorCount = Math.min(1, shuffledOthers.length);
                const distractors = shuffledOthers.slice(0, distractorCount).map(w => ({ word: w.word, translation: w.translation, correct: false }));

                // Build choices array with correct answer inserted at random position
                const correctChoice = { word: word.word, translation: word.translation, correct: true };
                const allChoices = [...distractors, correctChoice].sort(() => Math.random() - 0.5);
                const choices = allChoices;

                let selected = null;

                container.innerHTML = `
                    <div class="fc-progress-bar"><div class="fc-progress-fill" style="width:${progress}%"></div></div>
                    <div class="fc-counter">${currentCard + 1} / ${words.length}</div>

                    <div class="fc-wrap">
                        <div class="fc-body">
                            <div class="fc-question">What do you hear?</div>
                            ${word.audioUrl ? `
                            <button class="fc-audio-btn" id="fc-audio" onclick="playAudio('${word.audioUrl}')">
                                <svg viewBox="0 0 24 24" fill="currentColor" width="60" height="60">
                                    <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM16.5 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                                </svg>
                            </button>` : ''}
                            <div class="fc-choices">
                                ${choices.map((c, i) => `
                                <div class="fc-choice-flip" id="fc-flip-${i}" data-word="${c.word.replace(/"/g,'&quot;')}" data-translation="${(c.translation||'').replace(/"/g,'&quot;')}">
                                    <button class="fc-choice" id="fc-choice-${i}" onclick="selectChoice(${i}, ${c.correct})" onmouseenter="fcHoverIn(${i})" onmouseleave="fcHoverOut(${i})">
                                        <span class="fc-choice-num">${i + 1}</span>
                                        <span class="fc-choice-text" id="fc-choice-text-${i}">${c.word}</span>
                                    </button>
                                </div>`).join('')}
                            </div>
                            <button class="sp-btn" id="sp-open-btn" data-word="${word.word.replace(/"/g,'&quot;')}" onclick="spOpen(this.dataset.word,'en-us')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 14a3 3 0 0 0 3-3V5a3 3 0 0 0-6 0v6a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 6 6.93V20H9v2h6v-2h-2v-2.07A7 7 0 0 0 19 11h-2z"/>
                                </svg>
                                Practice pronunciation
                            </button>
                        </div>
                        <div class="fc-bottom-bar">
                            <button class="fc-btn-skip" onclick="skipCard()">Can't listen now</button>
                            <button class="fc-btn-check" id="fc-check-btn" disabled onclick="checkAnswer()">Check</button>
                            <button class="fc-btn-next" id="fc-next-btn" style="display:none" onclick="nextCard()">Next →</button>
                        </div>
                    </div>
                `;

                // Auto-play audio
                if (word.audioUrl) setTimeout(() => playAudio(word.audioUrl), 300);

                window.selectChoice = (idx, isCorrect) => {
                    document.querySelectorAll('.fc-choice').forEach(el => el.classList.remove('selected'));
                    document.getElementById(`fc-choice-${idx}`).classList.add('selected');
                    selected = { idx, isCorrect };
                    const btn = document.getElementById('fc-check-btn');
                    btn.disabled = false;
                    btn.classList.add('active');
                };


                window.checkAnswer = () => {
                    if (!selected) return;
                    // Mark correct/wrong
                    const choiceEl = document.getElementById(`fc-choice-${selected.idx}`);
                    choiceEl.classList.remove('selected');
                    choiceEl.classList.add(selected.isCorrect ? 'correct' : 'wrong');
                    if (!selected.isCorrect) {
                        choices.forEach((c, i) => { if (c.correct) document.getElementById(`fc-choice-${i}`).classList.add('correct'); });
                    }
                    // Play correct-answer animation + sound when right
                    if (selected.isCorrect) { playCorrectAnim(); playCorrectSound(); }
                    else playWrongSound();
                    // Flip button bottom-to-top: correct flips first, wrong flips 200ms later
                    choices.forEach((c, i) => {
                        const btnEl = document.getElementById(`fc-choice-${i}`);
                        const textEl = document.getElementById(`fc-choice-text-${i}`);
                        const numEl  = btnEl?.querySelector('.fc-choice-num');
                        if (!btnEl || !textEl) return;
                        const flipDelay = c.correct ? 0 : 200;
                        setTimeout(() => {
                            btnEl.classList.add('flipping');
                            setTimeout(() => {
                                textEl.textContent = c.translation;
                                if (numEl) numEl.style.visibility = 'hidden';
                            }, 225);
                            setTimeout(() => {
                                btnEl.classList.remove('flipping');
                                btnEl.classList.add('flipped');
                            }, 460);
                        }, flipDelay);
                    });
                    // Hide inline check, show next in bottom bar
                    const checkBtn = document.getElementById('fc-check-btn');
                    if (checkBtn) checkBtn.style.display = 'none';
                    const nextBtn = document.getElementById('fc-next-btn');
                    if (nextBtn) {
                        nextBtn.textContent = currentCard === words.length - 1 ? 'Continue →' : 'Next →';
                        nextBtn.style.display = 'block';
                    }
                };

                window.skipCard = () => nextCard();
            }

            const _fcHoverTimers = {};
            window.fcHoverIn = (i) => {
                const btn = document.getElementById(`fc-choice-${i}`);
                if (!btn || !btn.classList.contains('flipped')) return;
                const wrap = document.getElementById(`fc-flip-${i}`);
                if (!wrap) return;
                const word = wrap.dataset.word;
                const t = document.getElementById(`fc-choice-text-${i}`);
                if (!t || t.dataset.showing === 'original') return;
                t.dataset.showing = 'original';
                clearTimeout(_fcHoverTimers[i]);
                t.style.transition = 'none';
                t.style.opacity = '0';
                t.style.transform = 'translateY(6px)';
                _fcHoverTimers[i] = setTimeout(() => {
                    t.textContent = word;
                    t.style.transition = 'opacity 0.15s ease, transform 0.15s ease';
                    t.style.opacity = '1';
                    t.style.transform = 'translateY(0)';
                }, 80);
            };
            window.fcHoverOut = (i) => {
                const btn = document.getElementById(`fc-choice-${i}`);
                if (!btn || !btn.classList.contains('flipped')) return;
                const wrap = document.getElementById(`fc-flip-${i}`);
                if (!wrap) return;
                const translation = wrap.dataset.translation;
                const t = document.getElementById(`fc-choice-text-${i}`);
                if (!t || t.dataset.showing !== 'original') return;
                t.dataset.showing = 'translation';
                clearTimeout(_fcHoverTimers[i]);
                t.style.transition = 'none';
                t.style.opacity = '0';
                t.style.transform = 'translateY(-6px)';
                _fcHoverTimers[i] = setTimeout(() => {
                    t.textContent = translation;
                    t.style.transition = 'opacity 0.15s ease, transform 0.15s ease';
                    t.style.opacity = '1';
                    t.style.transform = 'translateY(0)';
                }, 80);
            };

            window.previousCard = () => {
                if (currentCard > 0) {
                    currentCard--;
                    renderCard();
                }
            };

            window.nextCard = async () => {
                if (currentCard < words.length - 1) {
                    currentCard++;
                    renderCard();
                } else {
                    // Complete section then show lottie animation → move to story
                    if (!flashcardCompleted) {
                        await completeSection(lessonId, 'flashcard');
                    } else {
                        debugLog('Flashcard already completed, skipping completion', 'info');
                    }
                    showCompletionAnimation('flashcard', () => loadStory(lessonId));
                }
            };

            renderCard();
        }

        function renderCompletedFlashcard(words, lessonId) {
            let currentCard = 0;

            function renderCard() {
                const word = words[currentCard];
                const container = document.getElementById('lesson-content');
                const progress = Math.round(((currentCard + 1) / words.length) * 100);

                const others = words.filter((_, i) => i !== currentCard);
                const distractor = others[Math.floor(Math.random() * others.length)] || { word: '—', translation: '—' };
                const correctFirst = Math.random() < 0.5;
                const choices = correctFirst
                    ? [{ word: word.word, translation: word.translation, correct: true }, { word: distractor.word, translation: distractor.translation, correct: false }]
                    : [{ word: distractor.word, translation: distractor.translation, correct: false }, { word: word.word, translation: word.translation, correct: true }];

                container.innerHTML = `
                    <div class="fc-progress-bar"><div class="fc-progress-fill" style="width:${progress}%"></div></div>
                    <div class="fc-counter">${currentCard + 1} / ${words.length}</div>
                    <div class="fc-wrap">
                        <div class="fc-body">
                            <div class="fc-question">What do you hear?</div>
                            ${word.audioUrl ? `
                            <button class="fc-audio-btn" onclick="playAudio('${word.audioUrl}')">
                                <svg viewBox="0 0 24 24" fill="currentColor" width="60" height="60">
                                    <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM16.5 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                                </svg>
                            </button>` : ''}
                            <div class="fc-choices">
                                ${choices.map((c, i) => `
                                <div class="fc-choice-flip">
                                <button class="fc-choice" id="cfc-choice-${i}" onclick="cSelectChoice(${i}, ${c.correct})">
                                    <span class="fc-choice-num">${i + 1}</span>
                                    <span class="fc-choice-text" id="cfc-choice-text-${i}">${c.word}</span>
                                </button>
                                </div>`).join('')}
                            </div>
                        </div>
                        <div class="fc-bottom-bar">
                            <button class="fc-btn-skip" onclick="loadStory('${lessonId}')">Story →</button>
                            <button class="fc-btn-check" id="cfc-check-btn" disabled onclick="cCheckAnswer()">Check</button>
                        </div>
                    </div>
                `;

                if (word.audioUrl) setTimeout(() => playAudio(word.audioUrl), 300);

                let cSelected = null;
                window.cSelectChoice = (idx, isCorrect) => {
                    document.querySelectorAll('.fc-choice').forEach(el => el.classList.remove('selected'));
                    document.getElementById(`cfc-choice-${idx}`).classList.add('selected');
                    cSelected = { idx, isCorrect };
                    const btn = document.getElementById('cfc-check-btn');
                    btn.disabled = false; btn.classList.add('active');
                };
                window.cCheckAnswer = () => {
                    if (!cSelected) return;
                    const el = document.getElementById(`cfc-choice-${cSelected.idx}`);
                    el.classList.remove('selected');
                    el.classList.add(cSelected.isCorrect ? 'correct' : 'wrong');
                    if (!cSelected.isCorrect) {
                        choices.forEach((c, i) => { if (c.correct) document.getElementById(`cfc-choice-${i}`).classList.add('correct'); });
                    }
                    // Flip button: correct flips first, wrong flips 200ms later
                    choices.forEach((c, i) => {
                        const btnEl = document.getElementById(`cfc-choice-${i}`);
                        const textEl = document.getElementById(`cfc-choice-text-${i}`);
                        if (!btnEl || !textEl) return;
                        const flipDelay = c.correct ? 0 : 200;
                        setTimeout(() => {
                            btnEl.classList.add('flipping');
                            setTimeout(() => {
                                textEl.textContent = c.translation;
                            }, 255);
                            setTimeout(() => btnEl.classList.remove('flipping'), 520);
                        }, flipDelay);
                    });
                    const btn = document.getElementById('cfc-check-btn');
                    btn.textContent = currentCard === words.length - 1 ? 'Continue →' : 'Next →';
                    btn.onclick = () => { if (currentCard < words.length - 1) { currentCard++; renderCard(); } else loadStory(lessonId); };
                };
                window.cSkipCard = () => { if (currentCard < words.length - 1) { currentCard++; renderCard(); } else loadStory(lessonId); };
            }

            renderCard();
        }

        async function loadStory(lessonId) {
            showLoading('lesson-content');
            const response = await apiCall(`/lesson/${lessonId}/story`);
            renderStory(response, lessonId);
        }

        function renderStory(response, lessonId) {
            debugLog('Rendering story...', 'info');

            const data = response.data || response;
            const section = data.section;
            const isCompleted = data.isCompleted || false;
            const storyText = section?.storyText || '';
            const audioUrl = section?.storyAudioUrl;
            const transcript = section?.storyTranscript || [];

            // Store section ID for progress ring tracking
            if (section?._id && lessonId) {
                if (!appState.lessonSections[lessonId]) appState.lessonSections[lessonId] = {};
                appState.lessonSections[lessonId].story = section._id;
            }

            debugLog(`Story text length: ${storyText.length}`, 'info');
            debugLog(`Has audio: ${!!audioUrl}`, 'info');
            debugLog(`Transcript words: ${transcript.length}`, 'info');
            debugLog(`Story already completed: ${isCompleted}`, 'info');

            // If already completed, show completion badge
            const completionBadge = isCompleted
                ? '<div style="text-align: center; margin-bottom: 20px;"><span class="badge badge-success" style="font-size: 1em; padding: 8px 16px;">✓ Already Completed</span></div>'
                : '';

            // Create highlighted story text with spans
            let highlightedStory = storyText;
            if (transcript.length > 0) {
                // Build the story with word-by-word spans using transcript position data
                let result = '';
                let lastPosition = 0;

                transcript.forEach((entry, index) => {
                    // Add any text before this word (whitespace, punctuation)
                    if (entry.wordStartPosition > lastPosition) {
                        result += storyText.substring(lastPosition, entry.wordStartPosition);
                    }

                    // Add the word wrapped in a span
                    const word = storyText.substring(entry.wordStartPosition, entry.wordEndPosition);
                    result += `<span class="story-word" data-word-index="${index}">${word}</span>`;

                    lastPosition = entry.wordEndPosition;
                });

                // Add any remaining text after the last word
                if (lastPosition < storyText.length) {
                    result += storyText.substring(lastPosition);
                }

                highlightedStory = result;
            }

            // Store transcript in a way that can be passed to onclick
            window.currentStoryTranscript = transcript;

            document.getElementById('lesson-content').innerHTML = `
                <div class="fc-progress-bar"><div class="fc-progress-fill" style="width:100%"></div></div>

                <div class="fc-wrap">
                    <div class="fc-body" style="max-width:680px; margin:0 auto; width:100%;">
                        <div class="fc-question">Reading Practice</div>
                        ${completionBadge}
                        <div id="story-text" class="story-content" style="font-size:1.05em; line-height:2.2; color:var(--text-primary); background:#242d3d; border-radius:16px; padding:24px 28px;">
                            ${highlightedStory || '<p>Story content not available</p>'}
                        </div>
                    </div>

                    ${audioUrl ? `
                    <div style="max-width:680px; margin:0 auto; width:100%; flex-shrink:0; padding: 10px 0 0;">
                        <button id="play-story-btn" class="story-play-btn" onclick="playStoryWithHighlight('${audioUrl}')">
                            <svg viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M8 5v14l11-7z"/></svg>
                            Play Story
                        </button>
                        <button id="pause-story-btn" class="story-play-btn story-pause-btn" style="display:none; width:100%;" onclick="pauseStoryAudio()">
                            <svg viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                            Pause
                        </button>
                    </div>
                    ` : ''}

                    <div class="fc-bottom-bar">
                        <button class="fc-btn-skip" onclick="loadFlashcard('${lessonId}')">← Flashcards</button>
                        <button class="fc-btn-check active" onclick="moveToTest('${lessonId}')">Continue →</button>
                    </div>
                </div>
            `;

            debugLog('✅ Story rendered with transcript support', 'info');
        }

        async function moveToTest(lessonId) {
            // Only complete if not already completed
            const storyResponse = await apiCall(`/lesson/${lessonId}/story`);
            const isCompleted = storyResponse?.data?.isCompleted || false;

            if (!isCompleted) {
                await completeSection(lessonId, 'story');
            } else {
                debugLog('Story already completed, skipping completion', 'info');
            }

            showCompletionAnimation('story', () => loadTest(lessonId));
        }

        async function loadTest(lessonId) {
            showLoading('lesson-content');
            const data = await apiCall(`/lesson/${lessonId}/test`);
            renderTest(data, lessonId);
        }

        function renderTest(response, lessonId) {
            debugLog('Rendering test...', 'info');

            const data = response.data || response;
            const section = data.section;
            const isCompleted = data.isCompleted || false;
            const questions = section?.questions || [];

            if (section?._id && lessonId) {
                if (!appState.lessonSections[lessonId]) appState.lessonSections[lessonId] = {};
                appState.lessonSections[lessonId].test = section._id;
            }

            debugLog(`Found ${questions.length} test questions`, 'info');

            if (questions.length === 0) {
                document.getElementById('lesson-content').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">✍️</div>
                        <div>No test available</div>
                        <button class="btn-primary" onclick="backToUnit()">Back to Curriculum</button>
                    </div>
                `;
                return;
            }

            // ---- one-at-a-time test state ----
            let currentQ = 0;
            const userAnswers = new Array(questions.length).fill(null); // null | string | string[]
            const results    = new Array(questions.length).fill(null); // null | boolean

            function getSelectedAnswer() {
                const q = questions[currentQ];
                const type = q.questionType || 'multiple_choice';
                if (type === 'fill_in_blank') {
                    const zone = document.getElementById('tq-drop-zone');
                    const word = zone?.querySelector('.tq-drop-word');
                    return word ? word.textContent.trim() : null;
                }
                if (type === 'multiple_select') {
                    return [...document.querySelectorAll('.tq-option')].filter(o => o.dataset.selected === 'true').map(o => o.dataset.value);
                }
                const sel = document.querySelector('.tq-option.selected');
                return sel ? sel.dataset.value : null;
            }

            function checkIsCorrect(q, answer) {
                const type = q.questionType || 'multiple_choice';
                if (type === 'multiple_select') {
                    const correct = q.correctAnswers || [];
                    const ans = Array.isArray(answer) ? answer : [];
                    return ans.length === correct.length &&
                        ans.every(a => correct.includes(a)) &&
                        correct.every(a => ans.includes(a));
                }
                return answer === q.correctAnswer;
            }

            function renderQuestion() {
                const q = questions[currentQ];
                const type = q.questionType || 'multiple_choice';
                const questionText = q.questionText || q.question;
                const progress = Math.round(((currentQ) / questions.length) * 100);
                const checked = results[currentQ] !== null;
                const isCorrect = results[currentQ];
                const savedAnswer = userAnswers[currentQ];

                const isLast = currentQ === questions.length - 1;
                const checkBtn = checked
                    ? `<button class="fc-btn-check active" onclick="tqNext()">${isLast ? 'See Results →' : 'Next →'}</button>`
                    : `<button class="fc-btn-check" id="tq-check-btn" disabled onclick="tqCheck()">Check</button>`;

                let explanationHtml = '';
                if (checked && q.explanation) {
                    explanationHtml = `<div class="tq-explanation ${isCorrect ? 'tq-exp-correct' : 'tq-exp-wrong'}">
                        <strong>${isCorrect ? '✓ Correct!' : '✗ Incorrect'}</strong> — ${q.explanation}
                    </div>`;
                } else if (checked) {
                    explanationHtml = `<div class="tq-explanation ${isCorrect ? 'tq-exp-correct' : 'tq-exp-wrong'}">
                        ${isCorrect ? '✓ Correct!' : `✗ Incorrect — Correct answer: <strong>${Array.isArray(q.correctAnswers) ? q.correctAnswers.join(', ') : q.correctAnswer}</strong>`}
                    </div>`;
                }

                let questionHtml = '';
                let optionsHtml = '';

                if (type === 'fill_in_blank') {
                    // Fixed width = longest option so zone never jumps
                    const longestOpt = (q.options || []).reduce((a, b) => b.length > a.length ? b : a, '');
                    const zoneWidth = Math.max(80, longestOpt.length * 11 + 32);

                    const dropCls = checked
                        ? (isCorrect ? 'tq-drop-zone correct' : 'tq-drop-zone incorrect')
                        : (savedAnswer ? 'tq-drop-zone filled' : 'tq-drop-zone');
                    const dropContent = savedAnswer
                        ? `<span class="tq-drop-word">${savedAnswer}</span>`
                        : `<span class="tq-drop-placeholder">_____</span>`;
                    const zoneHandlers = checked ? '' : `onpointerdown="tqZonePointerDown(event)" onclick="tqZoneClick(event)"`;

                    const rawText = questionText.replace(/_{2,}/g, `<span id="tq-drop-zone" class="${dropCls}" style="min-width:${zoneWidth}px;justify-content:center;" ${zoneHandlers}>${dropContent}</span>`);
                    questionHtml = `<div class="fc-question tq-fill-sentence" style="font-size:1.15em;margin-bottom:24px;line-height:2.2;">${rawText}</div>`;

                    // Word chips (options)
                    optionsHtml = `<div id="tq-chips" class="tq-chips">`;
                    (q.options || []).forEach((opt) => {
                        const isDropped = savedAnswer === opt;
                        const chipCls = isDropped ? 'tq-chip tq-chip-hidden' : 'tq-chip';
                        optionsHtml += `<div class="${chipCls}" data-value="${opt}"
                            onpointerdown="tqChipPointerDown(this,event)"
                            onclick="tqChipClick(this)"
                            >${opt}</div>`;
                    });
                    optionsHtml += `</div>`;
                } else if (type === 'multiple_select') {
                    questionHtml = `<div class="fc-question" style="font-size:1.1em;margin-bottom:20px;">${questionText}</div>`;
                    optionsHtml = `<div style="font-size:0.82em;color:var(--text-secondary);margin-bottom:10px;">(Select all that apply)</div>`;
                    (q.options || []).forEach((opt, i) => {
                        const savedAnswers = Array.isArray(savedAnswer) ? savedAnswer : [];
                        const wasSelected = savedAnswers.includes(opt);
                        let cls = 'tq-option';
                        if (checked) {
                            const correct = (q.correctAnswers || []).includes(opt);
                            if (correct) cls += ' correct';
                            else if (wasSelected) cls += ' incorrect';
                        } else if (wasSelected) cls += ' selected';
                        const clickable = checked ? '' : `onclick="tqToggle(this)"`;
                        optionsHtml += `
                            <div class="${cls}" data-value="${opt}" data-selected="${wasSelected}" ${clickable}>
                                <span class="tq-num">${String.fromCharCode(65+i)}</span>
                                <span>${opt}</span>
                            </div>`;
                    });
                } else {
                    questionHtml = `<div class="fc-question" style="font-size:1.1em;margin-bottom:20px;">${questionText}</div>`;
                    (q.options || []).forEach((opt, i) => {
                        const wasSelected = savedAnswer === opt;
                        let cls = 'tq-option';
                        if (checked) {
                            if (opt === q.correctAnswer) cls += ' correct';
                            else if (wasSelected) cls += ' incorrect';
                        } else if (wasSelected) cls += ' selected';
                        optionsHtml += `
                            <div class="${cls}" data-value="${opt}" onclick="tqSelect(this)">
                                <span class="tq-num">${String.fromCharCode(65+i)}</span>
                                <span>${opt}</span>
                            </div>`;
                    });
                }

                document.getElementById('lesson-content').innerHTML = `
                    <div class="fc-wrap">
                        <div class="fc-progress-bar"><div class="fc-progress-fill" style="width:${progress}%"></div></div>
                        <div class="fc-body" style="padding-bottom:16px;">
                            <div class="fc-question" style="margin-bottom:4px;font-size:0.85em;color:var(--text-secondary);">Question ${currentQ+1} of ${questions.length}</div>
                            ${questionHtml}
                            <div id="tq-options">${optionsHtml}</div>
                            ${explanationHtml}
                        </div>
                        <div class="fc-bottom-bar">
                            <button class="fc-btn-skip" onclick="loadStory('${lessonId}')">← Story</button>
                            ${checkBtn}
                        </div>
                    </div>`;
            }

            function renderResults() {
                const correct = results.filter(r => r === true).length;
                const score = Math.round((correct / questions.length) * 100);
                const scoreColor = score >= 80 ? 'var(--success)' : score >= 50 ? 'var(--warning)' : 'var(--error)';

                let reviewHtml = '';
                questions.forEach((q, idx) => {
                    const ok = results[idx];
                    const ans = userAnswers[idx];
                    const displayAns = Array.isArray(ans) ? ans.join(', ') : ans;
                    const correctAns = Array.isArray(q.correctAnswers) ? q.correctAnswers.join(', ') : q.correctAnswer;
                    reviewHtml += `
                        <div class="tq-review-item ${ok ? 'tq-review-ok' : 'tq-review-wrong'}">
                            <div class="tq-review-num">${ok ? '✓' : '✗'}</div>
                            <div>
                                <div style="font-weight:600;margin-bottom:4px;">${q.questionText || q.question}</div>
                                <div style="font-size:0.85em;color:var(--text-secondary);">Your answer: <em>${displayAns || '—'}</em></div>
                                ${!ok ? `<div style="font-size:0.85em;color:var(--success);">Correct: <em>${correctAns}</em></div>` : ''}
                            </div>
                        </div>`;
                });

                document.getElementById('lesson-content').innerHTML = `
                    <div class="fc-wrap">
                        <div class="fc-progress-bar"><div class="fc-progress-fill" style="width:100%"></div></div>
                        <div class="fc-body" style="padding-bottom:16px;">
                            <div style="text-align:center;padding:24px 0 16px;">
                                <div style="font-size:3em;font-weight:800;color:${scoreColor};">${score}%</div>
                                <div style="font-size:1.1em;color:var(--text-secondary);margin-top:4px;">${correct} / ${questions.length} correct</div>
                            </div>
                            <div>${reviewHtml}</div>
                        </div>
                        <div class="fc-bottom-bar">
                            <button class="fc-btn-skip" onclick="loadStory('${lessonId}')">← Story</button>
                            <button class="fc-btn-check active" id="tq-finish-btn">Finish ✓</button>
                        </div>
                    </div>`;

                document.getElementById('tq-finish-btn').addEventListener('click', async () => {
                    if (!isCompleted) {
                        await completeTestWithScore(lessonId, score);
                    }
                    showCompletionAnimation('test', () => backToUnit());
                });
            }

            // ---- pointer-based drag for fill_in_blank (no HTML5 drag API) ----
            let _tqDragging = null; // { val, source, floater, originEl }

            function _tqFindZone() { return document.getElementById('tq-drop-zone'); }
            function _tqFindChip(val) { return [...document.querySelectorAll('.tq-chip')].find(c => c.dataset.value === val) || null; }

            function _tqStartDrag(val, source, originEl, clientX, clientY) {
                // create floating clone that follows the pointer
                const floater = document.createElement('div');
                floater.textContent = val;
                floater.style.cssText = `position:fixed;z-index:9999;pointer-events:none;padding:10px 22px;border-radius:24px;border:2px solid #9333ea;background:rgba(147,51,234,0.35);color:#fff;font-size:1em;font-weight:700;white-space:nowrap;transform:translate(-50%,-50%);transition:none;box-shadow:0 4px 20px rgba(147,51,234,0.4);`;
                floater.style.left = clientX + 'px';
                floater.style.top  = clientY + 'px';
                document.body.appendChild(floater);

                // hide origin
                if (source === 'chip') {
                    originEl.classList.add('tq-chip-hidden');
                } else {
                    const zone = _tqFindZone();
                    if (zone) {
                        zone.classList.remove('filled');
                        zone.innerHTML = `<span class="tq-drop-placeholder">_____</span>`;
                        zone.draggable = false;
                    }
                    _tqDisableCheck();
                }

                _tqDragging = { val, source, floater, originEl };
            }

            function _tqMoveDrag(clientX, clientY) {
                if (!_tqDragging) return;
                _tqDragging.floater.style.left = clientX + 'px';
                _tqDragging.floater.style.top  = clientY + 'px';
            }

            function _tqEndDrag(clientX, clientY) {
                if (!_tqDragging) return;
                const { val, source, floater, originEl } = _tqDragging;
                _tqDragging = null;
                floater.remove();

                // check if dropped over the zone
                const zone = _tqFindZone();
                let droppedOnZone = false;
                if (zone) {
                    const r = zone.getBoundingClientRect();
                    droppedOnZone = clientX >= r.left && clientX <= r.right && clientY >= r.top && clientY <= r.bottom;
                }

                if (droppedOnZone) {
                    _tqPlaceWord(val);
                } else {
                    // return to origin
                    if (source === 'chip') {
                        originEl.classList.remove('tq-chip-hidden');
                    } else {
                        // came from zone — already cleared, restore chip
                        const chip = _tqFindChip(val);
                        if (chip) chip.classList.remove('tq-chip-hidden');
                    }
                }
            }

            // pointer events on document
            document.addEventListener('pointermove', e => _tqMoveDrag(e.clientX, e.clientY));
            document.addEventListener('pointerup',   e => _tqEndDrag(e.clientX, e.clientY));

            // exposed so chip/zone HTML can call on pointerdown
            window.tqChipPointerDown = (el, e) => {
                if (el.classList.contains('tq-chip-hidden')) return;
                e.preventDefault();
                _tqStartDrag(el.dataset.value, 'chip', el, e.clientX, e.clientY);
            };

            window.tqZonePointerDown = (e) => {
                const zone = _tqFindZone();
                if (!zone || !zone.classList.contains('filled')) return;
                const word = zone.querySelector('.tq-drop-word');
                if (!word) return;
                e.preventDefault();
                _tqStartDrag(word.textContent.trim(), 'zone', zone, e.clientX, e.clientY);
            };

            window.tqChipClick = (el) => {
                if (el.classList.contains('tq-chip-hidden') || _tqDragging) return;
                _tqPlaceWord(el.dataset.value);
            };

            window.tqZoneClick = (e) => {
                if (_tqDragging) return;
                const zone = _tqFindZone();
                if (!zone || !zone.classList.contains('filled')) return;
                _tqClearDrop();
            };

            function _tqPlaceWord(val) {
                const zone = _tqFindZone();
                if (!zone) return;
                // show all chips, hide the placed one
                document.querySelectorAll('.tq-chip').forEach(c => c.classList.remove('tq-chip-hidden'));
                const chip = _tqFindChip(val);
                if (chip) chip.classList.add('tq-chip-hidden');
                // fill zone
                zone.classList.remove('incorrect');
                zone.classList.add('filled');
                zone.innerHTML = `<span class="tq-drop-word">${val}</span>`;
                // enable check
                const btn = document.getElementById('tq-check-btn');
                if (btn) { btn.disabled = false; btn.classList.add('active'); }
            }

            function _tqClearDrop() {
                const zone = _tqFindZone();
                if (!zone) return;
                const word = zone.querySelector('.tq-drop-word');
                const val = word?.textContent.trim();
                zone.classList.remove('filled', 'correct', 'incorrect');
                zone.innerHTML = `<span class="tq-drop-placeholder">_____</span>`;
                if (val) { const chip = _tqFindChip(val); if (chip) chip.classList.remove('tq-chip-hidden'); }
                _tqDisableCheck();
            }

            function _tqDisableCheck() {
                const btn = document.getElementById('tq-check-btn');
                if (btn) { btn.disabled = true; btn.classList.remove('active'); }
            }

            // ---- global helpers called from inline onclick ----
            window.tqSelect = (el) => {
                if (el.classList.contains('correct') || el.classList.contains('incorrect')) return;
                document.querySelectorAll('.tq-option').forEach(o => o.classList.remove('selected'));
                el.classList.add('selected');
                const btn = document.getElementById('tq-check-btn');
                if (btn) btn.disabled = false, btn.classList.add('active');
            };

            window.tqToggle = (el) => {
                const isSelected = el.dataset.selected === 'true';
                el.dataset.selected = (!isSelected).toString();
                el.classList.toggle('selected', !isSelected);
                const anySelected = [...document.querySelectorAll('.tq-option')].some(o => o.dataset.selected === 'true');
                const btn = document.getElementById('tq-check-btn');
                if (btn) { btn.disabled = !anySelected; btn.classList.toggle('active', anySelected); }
            };

            window.tqCheck = () => {
                const answer = getSelectedAnswer();
                userAnswers[currentQ] = answer;
                const correct = checkIsCorrect(questions[currentQ], answer);
                results[currentQ] = correct;
                // Fire animation + sound BEFORE re-render so it's instant with no layout lag
                if (correct) { _tqPlayCorrectAnim(); playCorrectSound(); }
                else playWrongSound();
                renderQuestion();
            };

            function _tqPlayCorrectAnim() { playCorrectAnim(); }

            window.tqNext = () => {
                if (currentQ < questions.length - 1) {
                    currentQ++;
                    renderQuestion();
                } else {
                    renderResults();
                }
            };

            renderQuestion();
            debugLog('✅ Test rendered (one-at-a-time mode)', 'info');
        }

        async function completeTestWithScore(lessonId, testScore) {
            try {
                const timeSpent = 300; // 5 minutes for test

                const response = await apiCall(`/lesson/${lessonId}/test/complete`, 'POST', {
                    timeSpent: timeSpent,
                    testScore: testScore
                });

                debugLog(`✅ Test completed with score ${testScore}%`, 'info');

                // Update progress data in appState
                if (response.data) {
                    appState.completedSections = response.data.completedSections || appState.completedSections;
                    appState.completedLessons = response.data.completedLessons || appState.completedLessons;
                    debugLog(`Updated progress: ${appState.completedLessons.length} lessons, ${appState.completedSections.length} sections`, 'info');
                }
            } catch (error) {
                debugLog(`Error completing test: ${error.message}`, 'error');
                throw error;
            }
        }

        function selectAnswer(element, questionName, value) {
            element.parentElement.querySelectorAll('.answer-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            element.classList.add('selected');
            element.querySelector('input[type="radio"]').checked = true;
        }

        function toggleCheckbox(element, questionName, value) {
            const checkbox = element.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;

            if (checkbox.checked) {
                element.classList.add('selected');
            } else {
                element.classList.remove('selected');
            }
        }

        async function completeSection(lessonId, sectionType) {
            try {
                // Track time spent (approximate - 3 minutes for flashcard/story, 5 for test)
                const timeSpent = sectionType === 'test' ? 300 : 180;

                const response = await apiCall(`/lesson/${lessonId}/${sectionType}/complete`, 'POST', {
                    completedAt: new Date().toISOString(),
                    timeSpent: timeSpent
                });

                debugLog(`✅ ${sectionType} section completed`, 'info');

                // Update progress data in appState
                if (response.data) {
                    appState.completedSections = response.data.completedSections || appState.completedSections;
                    appState.completedLessons = response.data.completedLessons || appState.completedLessons;
                    debugLog(`Updated progress: ${appState.completedLessons.length} lessons, ${appState.completedSections.length} sections`, 'info');
                }
            } catch (error) {
                debugLog(`Error completing ${sectionType} section: ${error.message}`, 'error');
                // Don't block the user flow if completion tracking fails
            }
        }

        // ---- Correct answer animation (global, reused by flashcard + test) ----
        function playCorrectAnim() {
            const overlay = document.getElementById('tq-correct-overlay');
            const player  = document.getElementById('tq-correct-player');
            if (!overlay) return;
            clearTimeout(window._correctAnimTimer);

            // Show instantly — no src swap, player is already loaded
            overlay.classList.add('visible');
            if (player && player.seek) player.seek(0);
            if (player && player.play) player.play();

            // Hide after 800ms, flash again immediately (double hit, no gap lag)
            window._correctAnimTimer = setTimeout(() => {
                overlay.classList.remove('visible');
                // tiny gap so browser repaints, then instant second hit
                requestAnimationFrame(() => requestAnimationFrame(() => {
                    overlay.classList.add('visible');
                    if (player && player.seek) player.seek(0);
                    if (player && player.play) player.play();
                    window._correctAnimTimer = setTimeout(() => {
                        overlay.classList.remove('visible');
                    }, 800);
                }));
            }, 800);
        }

        // ---- Lottie completion overlay ----
        const _lottieFiles = [
            'assets/congratulations (1).lottie',
            'assets/finish (2).lottie',
        ];
        const _lottieMainLabels = {
            flashcard: ['Great job!', 'Well done!', 'Excellent!', 'Awesome!'],
            story:     ['Amazing!',  'Brilliant!', 'Fantastic!', 'Well done!'],
            test:      ['Congrats!', 'Nailed it!', 'Great job!', 'Excellent!'],
        };
        const _lottieSubLabels = {
            flashcard: 'Flashcards complete!',
            story:     'Story finished!',
            test:      'Test passed!',
        };
        const _lottieFloatingWords = [
            'Great!', 'Wow!', '🎉', 'Yes!', '🔥', 'Nice!', 'Epic!', '⭐', 'Top!', '💪'
        ];

        function _spawnPraiseWords(container) {
            container.innerHTML = '';
            // pick 5 random words and scatter them around the animation
            const pool = [..._lottieFloatingWords].sort(() => Math.random() - 0.5).slice(0, 5);
            const positions = [
                { top: '8%',  left: '5%'  },
                { top: '5%',  right: '8%' },
                { top: '42%', left: '-2%' },
                { top: '38%', right: '-2%'},
                { top: '75%', left: '12%' },
            ];
            const colors = [
                { bg: 'rgba(147,51,234,0.28)', color: '#e9d5ff' },
                { bg: 'rgba(251,191,36,0.28)', color: '#fde68a' },
                { bg: 'rgba(34,197,94,0.28)',  color: '#86efac' },
                { bg: 'rgba(239,68,68,0.28)',  color: '#fca5a5' },
                { bg: 'rgba(59,130,246,0.28)', color: '#93c5fd' },
            ];
            pool.forEach((word, i) => {
                const el = document.createElement('div');
                el.className = 'lottie-word';
                el.textContent = word;
                const pos = positions[i] || { top: '50%', left: '50%' };
                const col = colors[i % colors.length];
                Object.assign(el.style, pos);
                el.style.background  = col.bg;
                el.style.color       = col.color;
                el.style.fontSize    = (0.8 + Math.random() * 0.55).toFixed(2) + 'em';
                el.style.animationDelay = (i * 0.13) + 's';
                container.appendChild(el);
            });
        }

        function showCompletionAnimation(sectionType, callback) {
            const overlay   = document.getElementById('lottie-overlay');
            const player    = document.getElementById('lottie-player');
            const praise    = document.getElementById('lottie-praise');
            const mainLabel = document.getElementById('lottie-main-label');
            const subLabel  = document.getElementById('lottie-sub-label');
            const btn       = document.getElementById('lottie-continue-btn');

            // Reset animated elements
            mainLabel.classList.remove('pop');
            subLabel.classList.remove('pop');
            btn.classList.remove('pop');

            // Always use the finish animation — restart it
            if (player) {
                const src = 'assets/finish (2).lottie';
                if (player.getAttribute('src') !== src) {
                    player.setAttribute('src', src);
                    setTimeout(() => { try { player.seek(0); player.play(); } catch(e){} }, 100);
                } else {
                    try { player.seek(0); player.play(); } catch(e){}
                    setTimeout(() => { try { player.seek(0); player.play(); } catch(e){} }, 50);
                }
            }

            // Pick random main label
            const labels = _lottieMainLabels[sectionType] || ['Well done!', 'Great job!', 'Amazing!'];
            mainLabel.textContent = labels[Math.floor(Math.random() * labels.length)];
            subLabel.textContent  = _lottieSubLabels[sectionType] || 'Keep going!';

            // Spawn floating words
            if (praise) _spawnPraiseWords(praise);

            // Store callback on continue button
            window._lottieContinue = () => {
                overlay.classList.remove('visible');
                window._lottieContinue = null;
                if (callback) callback();
            };

            // Show overlay then trigger pop-in animations
            overlay.classList.add('visible');
            requestAnimationFrame(() => requestAnimationFrame(() => {
                mainLabel.classList.add('pop');
                subLabel.classList.add('pop');
                btn.classList.add('pop');
            }));
        }
        // ------------------------------------

        // Initialize
        updateBreadcrumb();
        debugLog('🚀 App initialized', 'info');
        debugLog(`API Base: ${API_BASE}`, 'info');
        debugLog(`Auth Base: ${AUTH_BASE}`, 'info');

        // Check authentication status
        checkAuth();

        // ── Speech Practice ────────────────────────────────────────────────────
        const spState = {
            word: '',
            language: 'en-us',
            mediaRecorder: null,
            chunks: [],
            isRecording: false,
            isEvaluating: false,
        };

        function spScoreColor(score) {
            if (score >= 80) return 'var(--success)';
            if (score >= 50) return 'var(--warning)';
            return 'var(--error)';
        }

        // Open the speech practice panel for a given word
        function spOpen(word, language) {
            spState.word = word;
            spState.language = language || 'en-us';
            spState.chunks = [];
            spState.isRecording = false;
            spState.isEvaluating = false;

            document.getElementById('sp-word-label').textContent = word;
            document.getElementById('sp-hint').textContent = 'Tap the mic and say the word';
            document.getElementById('sp-mic-btn').classList.remove('recording');
            document.getElementById('sp-result').classList.remove('visible');
            document.getElementById('sp-words-list').innerHTML = '';
            document.getElementById('sp-overall-score').textContent = '';

            document.getElementById('sp-overlay').classList.add('open');

            // Auto-start recording after panel slides in
            setTimeout(() => spToggleRecording(), 350);
        }

        function spClose() {
            document.getElementById('sp-overlay').classList.remove('open');
            if (spState.mediaRecorder && spState.isRecording) {
                spState.mediaRecorder.stop();
            }
            spState.isRecording = false;
            spState.isEvaluating = false;
        }

        // Close when clicking the dark backdrop (not the panel itself)
        function spOverlayClick(e) {
            if (e.target === document.getElementById('sp-overlay')) spClose();
        }

        async function spToggleRecording() {
            if (spState.isEvaluating) return;

            if (spState.isRecording) {
                // Stop recording → will trigger onstop → evaluate
                spState.mediaRecorder.stop();
                return;
            }

            // Start recording
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                spState.chunks = [];
                spState.mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });

                spState.mediaRecorder.ondataavailable = e => {
                    if (e.data.size > 0) spState.chunks.push(e.data);
                };

                spState.mediaRecorder.onstop = async () => {
                    // Stop all tracks
                    stream.getTracks().forEach(t => t.stop());
                    spState.isRecording = false;
                    document.getElementById('sp-mic-btn').classList.remove('recording');
                    document.getElementById('sp-hint').textContent = 'Evaluating…';
                    spState.isEvaluating = true;

                    const blob = new Blob(spState.chunks, { type: 'audio/webm' });
                    await spEvaluate(blob);
                };

                spState.mediaRecorder.start();
                spState.isRecording = true;
                document.getElementById('sp-mic-btn').classList.add('recording');
                document.getElementById('sp-hint').textContent = 'Recording… tap again to stop';
            } catch (err) {
                debugLog(`Microphone error: ${err.message}`, 'error');
                document.getElementById('sp-hint').textContent = 'Microphone access denied';
            }
        }

        async function spEvaluate(blob) {
            try {
                // Convert webm blob to wav via AudioContext
                const wavBlob = await spConvertToWav(blob);

                const formData = new FormData();
                formData.append('file', wavBlob, 'audio.wav');
                formData.append('text', spState.word);
                formData.append('language', spState.language);

                debugLog(`POST ${SPEECH_BASE}/evaluate`, 'info');

                const response = await fetch(`${SPEECH_BASE}/evaluate`, {
                    method: 'POST',
                    credentials: 'include',
                    body: formData,
                });

                const data = await response.json();
                debugLog(`Speech evaluate response: ${JSON.stringify(data)}`, response.ok ? 'info' : 'error');

                if (!response.ok) throw new Error(data.message || 'Evaluation failed');

                spShowResult(data);
            } catch (err) {
                debugLog(`Speech evaluation error: ${err.message}`, 'error');
                document.getElementById('sp-hint').textContent = 'Could not evaluate. Try again.';
                spState.isEvaluating = false;
            }
        }

        // Convert any audio blob to 16kHz mono WAV using Web Audio API
        async function spConvertToWav(blob) {
            const arrayBuffer = await blob.arrayBuffer();
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
            const decoded = await audioCtx.decodeAudioData(arrayBuffer);
            audioCtx.close();

            // Mix down to mono
            const numSamples = decoded.length;
            const numChannels = decoded.numberOfChannels;
            const mono = new Float32Array(numSamples);
            for (let ch = 0; ch < numChannels; ch++) {
                const channelData = decoded.getChannelData(ch);
                for (let i = 0; i < numSamples; i++) mono[i] += channelData[i];
            }
            for (let i = 0; i < numSamples; i++) mono[i] /= numChannels;

            // Encode as PCM WAV
            const wavBuffer = spEncodeWav(mono, 16000);
            return new Blob([wavBuffer], { type: 'audio/wav' });
        }

        function spEncodeWav(samples, sampleRate) {
            const numSamples = samples.length;
            const buffer = new ArrayBuffer(44 + numSamples * 2);
            const view = new DataView(buffer);

            function writeStr(offset, str) {
                for (let i = 0; i < str.length; i++) view.setUint8(offset + i, str.charCodeAt(i));
            }

            writeStr(0, 'RIFF');
            view.setUint32(4, 36 + numSamples * 2, true);
            writeStr(8, 'WAVE');
            writeStr(12, 'fmt ');
            view.setUint32(16, 16, true);       // chunk size
            view.setUint16(20, 1, true);         // PCM
            view.setUint16(22, 1, true);         // mono
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true); // byte rate
            view.setUint16(32, 2, true);         // block align
            view.setUint16(34, 16, true);        // bits per sample
            writeStr(36, 'data');
            view.setUint32(40, numSamples * 2, true);

            let offset = 44;
            for (let i = 0; i < numSamples; i++) {
                const s = Math.max(-1, Math.min(1, samples[i]));
                view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
                offset += 2;
            }
            return buffer;
        }

        function spBurstConfetti() {
            // Find Done button as origin point
            const btn = document.querySelector('.sp-close-btn');
            const rect = btn ? btn.getBoundingClientRect() : { left: window.innerWidth/2, top: window.innerHeight*0.8, width: 0, height: 0 };
            const originX = rect.left + rect.width / 2;
            const originY = rect.top + rect.height / 2;

            const canvas = document.createElement('canvas');
            canvas.style.cssText = `position:fixed;inset:0;width:100%;height:100%;pointer-events:none;z-index:9999;`;
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            document.body.appendChild(canvas);
            const ctx = canvas.getContext('2d');

            const colors = ['#58CC03','#FF9601','#FF4B4B','#9333ea','#fff','#FFD700','#00cfff'];
            const particles = Array.from({ length: 72 }, () => {
                const angle = Math.random() * Math.PI * 2;
                const speed = 4 + Math.random() * 9;
                return {
                    x: originX, y: originY,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed - 6,
                    size: 5 + Math.random() * 6,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    rot: Math.random() * 360,
                    rotV: (Math.random() - 0.5) * 12,
                    alpha: 1,
                    shape: Math.random() > 0.5 ? 'rect' : 'circle',
                };
            });

            let frame;
            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                let alive = false;
                particles.forEach(p => {
                    p.x += p.vx; p.y += p.vy;
                    p.vy += 0.35; // gravity
                    p.vx *= 0.98;
                    p.rot += p.rotV;
                    p.alpha -= 0.018;
                    if (p.alpha <= 0) return;
                    alive = true;
                    ctx.save();
                    ctx.globalAlpha = Math.max(0, p.alpha);
                    ctx.fillStyle = p.color;
                    ctx.translate(p.x, p.y);
                    ctx.rotate(p.rot * Math.PI / 180);
                    if (p.shape === 'circle') {
                        ctx.beginPath();
                        ctx.arc(0, 0, p.size / 2, 0, Math.PI * 2);
                        ctx.fill();
                    } else {
                        ctx.fillRect(-p.size / 2, -p.size / 4, p.size, p.size / 2);
                    }
                    ctx.restore();
                });
                if (alive) { frame = requestAnimationFrame(draw); }
                else { cancelAnimationFrame(frame); canvas.remove(); }
            }
            draw();
        }

        function spShowResult(data) {
            const words = data.words || [];

            // Use overall_score if it's meaningful (>0), otherwise average word quality scores
            let overall = data.overall_score ?? 0;
            if (overall === 0 && words.length > 0) {
                const avg = words.reduce((sum, w) => sum + (w.quality_score ?? 0), 0) / words.length;
                overall = Math.round(avg);
            }

            const overallEl = document.getElementById('sp-overall-score');
            overallEl.textContent = `${overall}`;
            overallEl.style.color = spScoreColor(overall);

            // 🎉 Confetti + sound for good scores
            if (overall >= 70) {
                playCorrectSound();
                setTimeout(() => spBurstConfetti(), 400);
            }

            const listEl = document.getElementById('sp-words-list');
            listEl.innerHTML = words.map(w => {
                const score = w.quality_score ?? 0;
                const color = spScoreColor(score);
                return `
                    <div class="sp-word-row">
                        <div class="sp-word-label">${w.word}</div>
                        <div class="sp-bar-wrap">
                            <div class="sp-bar-fill" style="width:${score}%;background:${color};"></div>
                        </div>
                        <div class="sp-word-score" style="color:${color};">${score}</div>
                    </div>`;
            }).join('');

            document.getElementById('sp-result').classList.add('visible');
            document.getElementById('sp-hint').textContent = '';
            spState.isEvaluating = false;
        }
        // ── End Speech Practice ────────────────────────────────────────────────

        // ── Double-click Translate ────────────────────────────────────────────
        (function() {
            let activePopup = null;

            function removePopup() {
                if (activePopup) {
                    activePopup.remove();
                    activePopup = null;
                }
            }

            // Close popup on click outside
            document.addEventListener('mousedown', (e) => {
                if (activePopup && !activePopup.contains(e.target)) removePopup();
            });

            document.addEventListener('dblclick', async (e) => {
                // Don't trigger on inputs, buttons, etc.
                const tag = e.target.tagName;
                if (['INPUT', 'TEXTAREA', 'BUTTON', 'SELECT'].includes(tag)) return;

                const sel = window.getSelection();
                const word = sel?.toString().trim();
                if (!word || word.length < 1 || word.length > 40 || word.includes(' ')) return;

                removePopup();

                // Create popup
                const popup = document.createElement('div');
                popup.className = 'translate-popup';
                popup.innerHTML = `
                    <div class="tp-word">
                        ${word}
                        <button class="tp-speak" title="Listen">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/>
                            </svg>
                        </button>
                    </div>
                    <div class="tp-divider"></div>
                    <div class="tp-lang">Russian</div>
                    <div class="tp-translation" id="tp-ru"><span class="tp-loading">Translating...</span></div>
                    <div style="height:4px;"></div>
                    <div class="tp-lang">O'zbek</div>
                    <div class="tp-translation" id="tp-uz"><span class="tp-loading">Translating...</span></div>
                `;

                // Position popup near the double-click
                const x = e.clientX;
                const y = e.clientY;
                document.body.appendChild(popup);

                const pw = popup.offsetWidth;
                const ph = popup.offsetHeight;
                let left = x - pw / 2;
                let top = y + 20;

                // Keep within viewport
                if (left < 8) left = 8;
                if (left + pw > window.innerWidth - 8) left = window.innerWidth - pw - 8;
                if (top + ph > window.innerHeight - 8) top = y - ph - 12;

                popup.style.left = left + 'px';
                popup.style.top = top + 'px';
                popup.style.setProperty('--tp-arrow', (x - left) + 'px');

                activePopup = popup;

                // Speak button
                popup.querySelector('.tp-speak').addEventListener('click', () => {
                    if (typeof puter !== 'undefined' && puter.ai?.txt2speech) {
                        puter.ai.txt2speech(word, { language: 'en-US' }).then(audio => audio.play()).catch(() => {});
                    }
                });

                // Auto-speak
                if (typeof puter !== 'undefined' && puter.ai?.txt2speech) {
                    puter.ai.txt2speech(word, { language: 'en-US' }).then(audio => audio.play()).catch(() => {});
                }

                // Fetch translations
                try {
                    const [ruRes, uzRes] = await Promise.all([
                        fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(word)}&langpair=en|ru`),
                        fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(word)}&langpair=en|uz`)
                    ]);
                    const ruData = await ruRes.json();
                    const uzData = await uzRes.json();

                    const ruText = ruData?.responseData?.translatedText || 'No translation';
                    const uzText = uzData?.responseData?.translatedText || 'No translation';

                    if (activePopup) {
                        document.getElementById('tp-ru').textContent = ruText;
                        document.getElementById('tp-uz').textContent = uzText;
                    }
                } catch (err) {
                    if (activePopup) {
                        document.getElementById('tp-ru').textContent = 'Error loading';
                        document.getElementById('tp-uz').textContent = 'Error loading';
                    }
                }
            });
        })();
        // ── End Double-click Translate ────────────────────────────────────────
    </script>
</body>
</html>
